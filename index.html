<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Legends Arena</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-dark: #1a1b26;
            --bg-main: #24283b;
            --border-color: #414868;
            --text-main: #c0caf5;
            --primary: #bb9af7;
            --secondary: #7dcfff;
            --quality-1-color: #e0af68;
            --quality-2-color: #bb9af7;
            --quality-3-color: #ff9e64;
            --quality-4-color: #f7768e;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
        }
        .main-container {
            max-width: 1200px;
            margin: auto;
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            background-color: var(--bg-main);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            padding-bottom: 80px;
        }
        .screen { display: none; }
        .screen.active { display: block; }
        
        /* Navega√ß√£o */
        .desktop-nav { display: flex; }
        .mobile-nav { display: none; }

        .nav-button, .sub-nav-button {
            transition: all 0.3s ease;
            border-bottom: 4px solid transparent;
        }
        .nav-button.active, .sub-nav-button.active {
            border-bottom-color: var(--primary);
            color: white;
            background-color: var(--border-color);
        }
        .nav-button:hover:not(.active), .sub-nav-button:hover:not(.active) { background-color: #565f89; }
        
        .mobile-nav-button {
            transition: all 0.2s ease-in-out;
            color: var(--text-main);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            font-size: 0.75rem;
        }
        .mobile-nav-button.active {
            color: var(--primary);
            transform: translateY(-4px);
        }
        
        #mobile-more-menu {
            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
        }

        /* Raridade */
        .rarity-1 { border-color: #a9b1d6; } .rarity-1-bg { background-color: #a9b1d6; color: #1a1b26; }
        .rarity-2 { border-color: #73daca; } .rarity-2-bg { background-color: #73daca; color: #1a1b26; }
        .rarity-3 { border-color: #9ece6a; } .rarity-3-bg { background-color: #9ece6a; color: #1a1b26; }
        .rarity-4 { border-color: #e0af68; } .rarity-4-bg { background-color: #e0af68; color: #1a1b26; }
        .rarity-5 { border-color: #bb9af7; } .rarity-5-bg { background-color: #bb9af7; color: #1a1b26; }

        .quality-tier-1 { box-shadow: 0 0 8px var(--quality-1-color); }
        .quality-tier-2 { box-shadow: 0 0 12px var(--quality-2-color); }
        .quality-tier-3 { box-shadow: 0 0 16px var(--quality-3-color); }
        .quality-tier-4 { box-shadow: 0 0 20px var(--quality-4-color); }
        .quality-tier-5 { animation: rgb-glow 2s infinite linear; }

        @keyframes rgb-glow {
            0% { box-shadow: 0 0 20px #ff0000; }
            33% { box-shadow: 0 0 20px #00ff00; }
            66% { box-shadow: 0 0 20px #0000ff; }
            100% { box-shadow: 0 0 20px #ff0000; }
        }

        .rarity-5 .shine {
            animation: shine 2s infinite;
            background: linear-gradient(100deg, rgba(255,255,255,0) 20%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0) 80%);
        }
        @keyframes shine { to { background-position-x: -200%; } }
        
        .modal { transition: opacity 0.3s ease; }
        .progress-bar-bg { background-color: #1a1b26; border-radius: 99px; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(to right, var(--secondary), var(--primary)); transition: width 0.5s ease; }
        
        /* Battle Screen */
        #battle-arena { background-size: cover; background-position: center; border-radius: 0.5rem; overflow: hidden; }
        .battle-character { transition: transform 0.2s ease-out, filter 0.5s; position: relative; }
        .battle-character.dead { filter: grayscale(1) opacity(0.5); transform: translateY(20px); }
        .health-bar-bg { background-color: rgba(0,0,0,0.5); border-radius: 99px; overflow: hidden; border: 1px solid #1a1b26;}
        .health-bar-fill { background: linear-gradient(to right, #9ece6a, #73daca); transition: width 0.5s ease-in-out; }
        .health-bar-fill.enemy { background: linear-gradient(to right, #f7768e, #ff9e64); }

        @keyframes attack-animation-player { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1) translateX(20px); } }
        @keyframes attack-animation-enemy { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1) translateX(-20px); } }
        
        .attacking.player { animation: attack-animation-player 0.3s ease-in-out; }
        .attacking.enemy { animation: attack-animation-enemy 0.3s ease-in-out; }
        
        @keyframes skill-cast-animation {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.2); filter: brightness(2) drop-shadow(0 0 15px var(--primary)); }
            100% { transform: scale(1); filter: brightness(1); }
        }
        .skill-cast { animation: skill-cast-animation 0.5s ease-in-out; }

        @keyframes damage-float { 0% { transform: translateY(0); opacity: 1; } 100% { transform: translateY(-50px); opacity: 0; } }
        .damage-text {
            position: absolute; top: 20%; left: 50%; transform: translateX(-50%);
            font-size: 1.75rem; font-weight: 900; -webkit-text-stroke: 2px black;
            animation: damage-float 1s forwards; pointer-events: none; z-index: 10;
        }
        .damage-text.damage { color: #ff9e64; }
        .damage-text.heal { color: #9ece6a; }
        .damage-text.skill { color: var(--primary); font-size: 1rem; top: -10px; }
        
        .btn-grad {
            background-image: linear-gradient(to right, #DA22FF 0%, #9733EE  51%, #DA22FF  100%);
            transition: 0.5s;
            background-size: 200% auto;
            color: white;            
        }
        .btn-grad:hover { background-position: right center; }
        
        .home-character-display {
             filter: drop-shadow(0px 5px 15px rgba(0, 0, 0, 0.5));
             max-height: 45vh;
             margin-bottom: -20px;
        }

        #formation-character-list .relative {
            aspect-ratio: 150 / 200;
        }

        .formation-btn {
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(187, 154, 247, 0.9);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        .formation-btn:hover {
            background: rgba(187, 154, 247, 1);
            transform: translateX(-50%) scale(1.05);
        }

        @keyframes star-fragment-glow {
            0%, 100% { box-shadow: 0 0 10px #ffd700; }
            50% { box-shadow: 0 0 20px #ffd700, 0 0 30px #ffd700; }
        }
        .star-fragment { animation: star-fragment-glow 2s infinite; }

        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .custom-modal.show {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background: var(--bg-main);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }
        .custom-modal.show .custom-modal-content {
            transform: scale(1);
        }

        .achievement-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #1a1b26;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
            max-width: 300px;
        }
        .achievement-notification.show {
            transform: translateX(0);
        }

        .daily-reward-item {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .daily-reward-item:hover {
            transform: scale(1.05);
        }
        .daily-reward-item.claimed {
            opacity: 0.5;
            filter: grayscale(1);
        }
        .daily-reward-item.available {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
            animation: pulse-gold 2s infinite;
        }
        @keyframes pulse-gold {
            0%, 100% { box-shadow: 0 0 15px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 215, 0, 0.8); }
        }

        .battle-paused-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .desktop-nav { display: none; }
            .mobile-nav { display: flex; }
            .main-container { border-radius: 0; border: none; }
            body { padding: 0; }
            
            .formation-btn {
                font-size: 0.6rem;
                padding: 1px 4px;
                bottom: 2px;
            }
            
            .battle-character img {
                height: 80px !important;
            }
            
            .damage-text {
                font-size: 1.2rem;
            }

            .home-character-display {
                max-height: 50vh;
            }

            .achievement-notification {
                top: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                transform: translateY(-150%);
                transition: transform 0.3s ease;
            }
            .achievement-notification.show {
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="p-0 md:p-8">

    <div class="main-container overflow-hidden">
        <!-- Header -->
        <header class="hidden md:flex p-4 bg-gray-900/50 justify-between items-center border-b border-gray-700">
            <div>
                <h1 class="text-2xl font-bold text-white tracking-wider">Anime Legends Arena</h1>
                <p class="text-sm text-gray-400">Bem-vindo, <span id="username-display" class="font-bold">Jogador</span>! <button id="logout-btn" class="text-red-400 text-xs">(Sair)</button></p>
            </div>
            <div class="text-right">
                <div class="flex items-center gap-2"><img src="https://placehold.co/24x24/e0af68/1a1b26?text=$" class="rounded-full" alt="√çcone de Cristais"><span id="player-currency" class="text-lg font-semibold text-yellow-400">0</span></div>
                <div class="text-sm text-gray-400">Cristais</div>
                <div class="flex items-center gap-2 mt-1"><img src="https://i.ibb.co/pjB4k3YV/frag.png" class="rounded-full" alt="√çcone de Fragmentos"><span id="player-star-fragments" class="text-lg font-semibold text-yellow-300">0</span></div>
                <div class="text-sm text-gray-400">Fragmentos de Estrela</div>
            </div>
        </header>

        <!-- Desktop Navigation -->
        <nav class="desktop-nav bg-gray-900/30">
            <button data-screen="home" class="nav-button flex-1 p-4 font-semibold active">Home</button>
            <button data-screen="battle" class="nav-button flex-1 p-4 font-semibold">Batalha</button>
            <button data-screen="characters" class="nav-button flex-1 p-4 font-semibold">Her√≥is</button>
            <button data-screen="inventory" class="nav-button flex-1 p-4 font-semibold">Invent√°rio</button>
            <button data-screen="recruit" class="nav-button flex-1 p-4 font-semibold">Recrutar</button>
            <button data-screen="daily-rewards" class="nav-button flex-1 p-4 font-semibold">Recompensas</button>
            <button data-screen="achievements" class="nav-button flex-1 p-4 font-semibold">Conquistas</button>
            <button data-screen="systems" class="nav-button flex-1 p-4 font-semibold">Sistemas</button>
            <button data-screen="ranking" class="nav-button flex-1 p-4 font-semibold">Ranking</button>
            <button data-screen="admin" class="nav-button flex-1 p-4 font-semibold text-red-400 hidden">Admin</button>
        </nav>

        <main class="p-4 md:p-6 min-h-[60vh]">
            <!-- Screens -->
            <div id="home-screen" class="screen active"></div>
            <div id="battle-screen" class="screen"></div>
            <div id="battle-arena-screen" class="screen"></div>
            <div id="characters-screen" class="screen"></div>
            <div id="formation-screen" class="screen"></div>
            <div id="inventory-screen" class="screen"></div>
            <div id="recruit-screen" class="screen"></div>
            <div id="daily-rewards-screen" class="screen"></div>
            <div id="achievements-screen" class="screen"></div>
            <div id="systems-screen" class="screen"></div>
            <div id="prestige-screen" class="screen"></div>
            <div id="mastery-screen" class="screen"></div>
            <div id="pets-screen" class="screen"></div>
            <div id="artifacts-screen" class="screen"></div>
            <div id="events-screen" class="screen"></div>
            <div id="season-screen" class="screen"></div>
            <div id="ranking-screen" class="screen"></div>
            <div id="admin-screen" class="screen"></div>
        </main>

        <!-- Mobile Navigation -->
        <nav class="mobile-nav fixed bottom-0 left-0 right-0 bg-gray-900/80 backdrop-blur-sm border-t border-gray-700 justify-around p-2 z-40">
            <button data-screen="home" class="mobile-nav-button active"><span>üè†</span>Home</button>
            <button data-screen="battle" class="mobile-nav-button"><span>‚öîÔ∏è</span>Batalha</button>
            <button data-screen="characters" class="mobile-nav-button"><span>ü¶∏</span>Her√≥is</button>
            <button data-screen="inventory" class="mobile-nav-button"><span>üéí</span>Invent√°rio</button>
            <button id="mobile-more-btn" class="mobile-nav-button"><span>‚ò∞</span>Mais</button>
        </nav>
    </div>
    
    <!-- Achievement Notification -->
    <div id="achievement-notification" class="achievement-notification">
        <div id="achievement-content"></div>
    </div>
    
    <!-- Battle Paused Indicator -->
    <div id="battle-paused-indicator" class="battle-paused-indicator">
        <div class="text-center">
            <h3 class="text-lg font-bold mb-2">‚öîÔ∏è Batalha em Andamento</h3>
            <p class="text-sm">A batalha continua em segundo plano...</p>
            <button onclick="switchScreen('battle-arena')" class="mt-3 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                Voltar √† Batalha
            </button>
        </div>
    </div>
    
    <!-- Custom Modals -->
    <div id="custom-confirm-modal" class="custom-modal">
        <div class="custom-modal-content text-center">
            <h3 id="confirm-title" class="text-lg font-bold mb-4"></h3>
            <p id="confirm-message" class="mb-6"></p>
            <div class="flex gap-4 justify-center">
                <button id="confirm-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                <button id="confirm-ok" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="custom-alert-modal" class="custom-modal">
        <div class="custom-modal-content text-center">
            <h3 id="alert-title" class="text-lg font-bold mb-4">Aviso</h3>
            <p id="alert-message" class="mb-6"></p>
            <button id="alert-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">OK</button>
        </div>
    </div>

    <div id="custom-prompt-modal" class="custom-modal">
        <div class="custom-modal-content text-center">
            <h3 id="prompt-title" class="text-lg font-bold mb-4">Digite</h3>
            <p id="prompt-message" class="mb-4"></p>
            <input id="prompt-input" type="text" class="w-full bg-gray-700 text-white p-2 rounded mb-6">
            <div class="flex gap-4 justify-center">
                <button id="prompt-cancel" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                <button id="prompt-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">OK</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="recruit-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="character-detail-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="equipment-detail-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="pet-detail-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="artifact-detail-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="equip-select-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="formation-placement-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="battle-result-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    <div id="upgrade-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center hidden z-50 modal p-4"></div>
    
    <!-- Mobile "More" Menu -->
    <div id="mobile-more-menu" class="fixed bottom-[72px] right-4 bg-gray-800 rounded-lg p-2 shadow-lg z-50 hidden opacity-0 transform translate-y-2">
        <div class="flex flex-col gap-1">
            <div class="p-2 text-center text-sm border-b border-gray-700">
                <span id="mobile-username-display" class="font-bold"></span>
                <div class="flex justify-center gap-4 mt-1 text-xs">
                    <div class="flex items-center gap-1">
                        <span>üíé</span>
                        <span id="mobile-player-currency">0</span>
                    </div>
                    <div class="flex items-center gap-1">
                        <span>‚≠ê</span>
                        <span id="mobile-player-star-fragments">0</span>
                    </div>
                </div>
            </div>
            <button data-screen="recruit" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700"><span>‚ú®</span>Recrutar</button>
            <button data-screen="daily-rewards" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700"><span>üéÅ</span>Recompensas</button>
            <button data-screen="achievements" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700"><span>üèÖ</span>Conquistas</button>
            <button data-screen="systems" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700"><span>‚öôÔ∏è</span>Sistemas</button>
            <button data-screen="ranking" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700"><span>üèÜ</span>Ranking</button>
            <button data-screen="admin" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700 text-red-400 hidden"><span>‚öôÔ∏è</span>Admin</button>
            <button id="mobile-logout-btn" class="mobile-nav-button w-full justify-start text-left p-2 rounded hover:bg-gray-700 text-red-400"><span>üö™</span>Sair</button>
        </div>
    </div>

    <script>
        // --- CUSTOM MODAL FUNCTIONS ---
        function customAlert(message, title = 'Aviso') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-alert-modal');
                document.getElementById('alert-title').textContent = title;
                document.getElementById('alert-message').textContent = message;
                modal.classList.add('show');
                
                const okBtn = document.getElementById('alert-ok');
                okBtn.onclick = () => {
                    modal.classList.remove('show');
                    resolve();
                };
            });
        }

        function customConfirm(message, title = 'Confirma√ß√£o') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-confirm-modal');
                document.getElementById('confirm-title').textContent = title;
                document.getElementById('confirm-message').textContent = message;
                modal.classList.add('show');
                
                const cancelBtn = document.getElementById('confirm-cancel');
                const okBtn = document.getElementById('confirm-ok');
                
                cancelBtn.onclick = () => {
                    modal.classList.remove('show');
                    resolve(false);
                };
                
                okBtn.onclick = () => {
                    modal.classList.remove('show');
                    resolve(true);
                };
            });
        }

        function customPrompt(message, defaultValue = '', title = 'Digite') {
            return new Promise((resolve) => {
                const modal = document.getElementById('custom-prompt-modal');
                document.getElementById('prompt-title').textContent = title;
                document.getElementById('prompt-message').textContent = message;
                const input = document.getElementById('prompt-input');
                input.value = defaultValue;
                modal.classList.add('show');
                input.focus();
                
                const cancelBtn = document.getElementById('prompt-cancel');
                const okBtn = document.getElementById('prompt-ok');
                
                cancelBtn.onclick = () => {
                    modal.classList.remove('show');
                    resolve(null);
                };
                
                okBtn.onclick = () => {
                    modal.classList.remove('show');
                    resolve(input.value);
                };
                
                input.onkeypress = (e) => {
                    if (e.key === 'Enter') {
                        modal.classList.remove('show');
                        resolve(input.value);
                    }
                };
            });
        }

        // --- ACHIEVEMENT SYSTEM ---
        function showAchievement(title, description) {
            const notification = document.getElementById('achievement-notification');
            const content = document.getElementById('achievement-content');
            content.innerHTML = `
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üèÜ</span>
                    <div>
                        <div class="font-bold">${title}</div>
                        <div class="text-sm opacity-80">${description}</div>
                    </div>
                </div>
            `;
            notification.classList.add('show');
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        // --- GAME DATABASE ---
        const RarityColors = { 1: '#a9b1d6', 2: '#73daca', 3: '#9ece6a', 4: '#e0af68', 5: '#bb9af7' };
        const QualityTiers = { 1: { color: 'var(--quality-1-color)' }, 2: { color: 'var(--quality-2-color)' }, 3: { color: 'var(--quality-3-color)' }, 4: { color: 'var(--quality-4-color)' }, 5: { color: 'rgb(255,255,255)' } };
        const EQUIP_SLOTS = ['Arma', 'Elmo', 'Armadura', 'Botas', 'Acess√≥rio'];

        const GAME_DB = {
            characters: {
                'c001': { name: 'Leo', rarity: 4, atk: 120, def: 80, hp: 1000, speed: 100, image: 'https://i.ibb.co/gZX2f5wm/556-FB979-62-BC-4907-9600-EA6-E63-ED7-CC4.png', role: 'Dano', skill: { name: 'Golpe Furioso', type: 'damage', power: 2, cooldown: 3, description: 'Causa {power}% de dano de ATK em um √∫nico alvo.' } },
                'c002': { name: 'Elara', rarity: 5, atk: 150, def: 90, hp: 1100, speed: 120, image: 'https://placehold.co/150x200/bb9af7/1a1b26?text=Elara', role: 'Dano', skill: { name: 'Chuva Estelar', type: 'damage_aoe', power: 0.8, cooldown: 4, description: 'Causa {power}% de dano de ATK em todos os inimigos.' } },
                'c003': { name: 'Grom', rarity: 3, atk: 80, def: 150, hp: 1500, speed: 70, image: 'https://i.ibb.co/ymMLBs6H/425-F2314-84-EF-4272-97-D0-99708-E6-E16-A6.png', role: 'Tanque', skill: { name: 'Muralha de Escudos', type: 'buff_def', power: 0.3, cooldown: 4, description: 'Aumenta a DEF de todos os aliados em {power}% por 2 turnos.' } },
                'c004': { name: 'Faye', rarity: 4, atk: 140, def: 70, hp: 900, speed: 130, image: 'https://placehold.co/150x200/7dcfff/1a1b26?text=Faye', role: 'Dano', skill: { name: 'Flecha Precisa', type: 'damage_ignore_def', power: 1.5, cooldown: 3, description: 'Causa {power}% de dano de ATK, ignorando 50% da DEF do alvo.' } },
                'c005': { name: 'Zane', rarity: 5, atk: 160, def: 80, hp: 1000, speed: 115, image: 'https://placehold.co/150x200/ff9e64/1a1b26?text=Zane', role: 'Dano', skill: { name: 'L√¢mina das Sombras', type: 'damage', power: 2.2, cooldown: 4, description: 'Causa {power}% de dano de ATK em um √∫nico alvo.' } },
                'c006': { name: 'Nia', rarity: 2, atk: 70, def: 60, hp: 800, speed: 90, image: 'https://placehold.co/150x200/73daca/1a1b26?text=Nia', role: 'Suporte', skill: { name: 'Toque Curativo', type: 'heal', power: 3, cooldown: 3, description: 'Cura um aliado em {power}% do ATK de Nia.' } },
                'c007': { name: 'Kael', rarity: 1, atk: 50, def: 50, hp: 600, speed: 80, image: 'https://placehold.co/150x200/a9b1d6/1a1b26?text=Kael', role: 'Dano', skill: { name: 'Golpe Simples', type: 'damage', power: 1.2, cooldown: 2, description: 'Causa {power}% de dano de ATK.' } },
                'c008': { name: 'Seraphina', rarity: 5, atk: 140, def: 100, hp: 1200, speed: 110, image: 'https://placehold.co/150x200/bb9af7/1a1b26?text=Seraphina', role: 'Suporte', skill: { name: 'B√™n√ß√£o Celestial', type: 'heal_aoe', power: 1.5, cooldown: 5, description: 'Cura todos os aliados em {power}% do ATK de Seraphina.' } },
                'c009': { name: 'Jax', rarity: 4, atk: 130, def: 75, hp: 950, speed: 125, image: 'https://placehold.co/150x200/e0af68/1a1b26?text=Jax', role: 'Dano', skill: { name: 'Ataque Duplo', type: 'damage_multi', power: 0.9, hits: 2, cooldown: 3, description: 'Ataca 2 vezes causando {power}% de dano de ATK cada.' } },
                'c010': { name: 'Luna', rarity: 3, atk: 110, def: 85, hp: 1050, speed: 105, image: 'https://i.ibb.co/sd7NF3xR/Gemini-Generated-Image-pyyju9pyyju9pyyj.png', role: 'Dano', skill: { name: 'Raio Lunar', type: 'damage', power: 1.8, cooldown: 3, description: 'Causa {power}% de dano de ATK em um √∫nico alvo.' } }
            },
            equipment: {
                'e001': { name: 'Espada de Ferro', type: 'Arma', rarity: 1, stats: { atk: 15 }, image: 'https://i.ibb.co/60x7Z5bs/espada.png' },
                'e002': { name: 'Espada M√≠stica', type: 'Arma', rarity: 3, stats: { atk: 35 }, image: 'https://i.ibb.co/RpNvhVRG/espada-m.png' },
                'e003': { name: 'L√¢mina Lend√°ria', type: 'Arma', rarity: 5, stats: { atk: 60 }, image: 'https://i.ibb.co/DfXkS99K/lendaria.png' },
                'e004': { name: 'Elmo de Couro', type: 'Elmo', rarity: 1, stats: { def: 10 }, image: 'https://i.ibb.co/1GzR0BQC/couro.png' },
                'e005': { name: 'Elmo de A√ßo', type: 'Elmo', rarity: 2, stats: { def: 20 }, image: 'https://i.ibb.co/Mkz5p79x/ferro.png' },
                'e006': { name: 'Armadura Simples', type: 'Armadura', rarity: 1, stats: { def: 12, hp: 50 }, image: 'https://i.ibb.co/K1R4FjT/simples.png' },
                'e007': { name: 'Armadura Refor√ßada', type: 'Armadura', rarity: 3, stats: { def: 30, hp: 120 }, image: 'https://i.ibb.co/4zz8mMx/reforcada.png' },
                'e008': { name: 'Botas R√°pidas', type: 'Botas', rarity: 2, stats: { speed: 8 }, image: 'https://i.ibb.co/fd74F1xQ/botas-rapifdas.png' },
                'e009': { name: 'Anel de Poder', type: 'Acess√≥rio', rarity: 4, stats: { atk: 25, hp: 80 }, image: 'https://i.ibb.co/NgKGC6dH/anel.png' },
                'e010': { name: 'Amuleto M√≠stico', type: 'Acess√≥rio', rarity: 5, stats: { atk: 20, def: 20, hp: 100, speed: 5 }, image: 'https://i.ibb.co/GvpfLV0j/amuleto.png' }
            },
            pets: {
                'p001': { name: 'Kitsune Flamejante', rarity: 4, image: 'https://i.ibb.co/jvNh8hfH/kitsune.png', description: 'Aumenta o ATK de todos os her√≥is.', baseBonus: { atk_percent: 0.04 }, growthPerStar: { atk_percent: 0.01 } },
                'p002': { name: 'Guardi√£o R√∫nico', rarity: 5, image: 'https://i.ibb.co/ZRJDx3qj/guardiao.png', description: 'Aumenta a DEF de todos os her√≥is.', baseBonus: { def_percent: 0.07 }, growthPerStar: { def_percent: 0.015 } },
                'p003': { name: 'Sprite Veloz', rarity: 3, image: 'https://i.ibb.co/s9xPXKVG/sprite.png', description: 'Aumenta a VEL de todos os her√≥is.', baseBonus: { speed_percent: 0.02 }, growthPerStar: { speed_percent: 0.01 } }
            },
            artifacts: {
                'art001': { name: "Medalh√£o do Berserker", rarity: 4, image: 'https://i.ibb.co/67fNPXjT/berserker.png', description: 'Aumenta o ATK base de todos os her√≥is.', stats: { atk_percent: 10 } },
                'art002': { name: "√âgide Impenetr√°vel", rarity: 5, image: 'https://i.ibb.co/35DLRMNJ/impenetravel.png', description: 'Aumenta a DEF e HP base de todos os her√≥is.', stats: { def_percent: 15, hp_percent: 15 } },
                'art003': { name: "Botas de Hermes", rarity: 3, image: 'https://i.ibb.co/CjF49vG/botas.png', description: 'Aumenta a VEL base de todos os her√≥is.', stats: { speed_percent: 7 } },
                'art004': { name: "Lente do Ca√ßador", rarity: 4, image: 'https://i.ibb.co/qMkT1XZx/lente.png', description: 'Aumenta a Chance e Dano Cr√≠tico.', stats: { crit_chance: 5, crit_damage: 10 } },
                'art005': { name: "Coroa do Estrategista", rarity: 5, image: 'https://i.ibb.co/1YzWBj8B/coroa.png', description: 'Aumenta todos os status base em uma pequena quantidade.', stats: { atk_percent: 8, def_percent: 8, hp_percent: 8, speed_percent: 4 } },
                'art006': { name: "Selo do Conquistador", rarity: 5, image: 'https://i.ibb.co/Rpz1ycnC/selo.png', description: 'Aumenta massivamente o ATK e ignora uma parte da defesa inimiga (efeito passivo).', stats: { atk_percent: 20 } },
                'art007': { name: "Orbe da Sabedoria", rarity: 2, image: 'https://i.ibb.co/HfmbSKqQ/orbe.png', description: 'Aumenta o ganho de EXP para her√≥is.', stats: { exp_gain_percent: 15 } },
                'art008': { name: "Manto das Sombras", rarity: 4, image: 'https://i.ibb.co/WvWRdsq9/manto.png', description: 'Aumenta a esquiva e o dano cr√≠tico.', stats: { crit_damage: 15 } }
            },
            enemies: {
                'enemy001': { name: 'Goblin', atk: 60, def: 30, hp: 400, speed: 85, image: 'https://i.ibb.co/zHD4Z06V/goblin.png' },
                'enemy002': { name: 'Orc', atk: 90, def: 50, hp: 700, speed: 70, image: 'https://i.ibb.co/nNJxLQ60/orc.png' },
                'enemy003': { name: 'Drag√£o', atk: 200, def: 120, hp: 2000, speed: 60, image: 'https://i.ibb.co/YTQRrRT0/dragaob.png' },
                'enemy004': { name: 'Esqueleto', atk: 70, def: 40, hp: 500, speed: 90, image: 'https://i.ibb.co/3mqXwNB3/esq.png' },
                'enemy005': { name: 'Mago Sombrio', atk: 120, def: 60, hp: 800, speed: 100, image: 'https://i.ibb.co/wN1BbPNs/mago.png' }
            },
            stages: [
                { name: 'Floresta Sombria', background: 'https://i.ibb.co/04LXrB4/floresta.png', recommendedBP: 800, reward: 100 },
                { name: 'Caverna dos Goblins', background: 'https://i.ibb.co/DNpzKST/goblins.png', recommendedBP: 1200, reward: 150 },
                { name: 'Castelo Assombrado', background: 'https://i.ibb.co/HT8bJXx5/castelo.png', recommendedBP: 1800, reward: 200 },
                { name: 'Montanha do Drag√£o', background: 'https://i.ibb.co/k2gPwJXN/dragao.png', recommendedBP: 2500, reward: 300 },
                { name: 'Reino das Sombras', background: 'https://i.ibb.co/5Xd8nNpB/reino.png', recommendedBP: 3500, reward: 500 }
            ],
            items: {
                'exp_potion_1': { name: 'Po√ß√£o de EXP Pequena', type: 'level', value: 1000, image: 'https://i.ibb.co/jZztCXBw/xp-pequena.png' },
                'exp_potion_2': { name: 'Po√ß√£o de EXP Grande', type: 'level', value: 5000, image: 'https://i.ibb.co/JbxMPRG/xp-grande.png' },
                'refine_stone_1': { name: 'Pedra de Refinamento', type: 'refine', value: 1, image: 'https://i.ibb.co/4RkRq4Ck/refinamento.png' },
                'skill_tome_1': { name: 'Tomo de Habilidade', type: 'skill', value: 1, image: 'https://i.ibb.co/mr6CsGsh/tomo.png' }
            },
            achievements: {
                'first_hero': { name: 'Primeiro Her√≥i', description: 'Recrute seu primeiro her√≥i', reward: { currency: 500 }, completed: false },
                'level_10': { name: 'N√≠vel 10', description: 'Alcance o n√≠vel 10 com um her√≥i', reward: { starFragments: 10 }, completed: false },
                'level_50': { name: 'N√≠vel 50', description: 'Alcance o n√≠vel 50 com um her√≥i', reward: { starFragments: 50 }, completed: false },
                'level_100': { name: 'N√≠vel 100', description: 'Alcance o n√≠vel 100 com um her√≥i', reward: { starFragments: 100 }, completed: false },
                'bp_10k': { name: 'Poder 10K', description: 'Alcance 10.000 de BP total', reward: { currency: 1000 }, completed: false },
                'bp_100k': { name: 'Poder 100K', description: 'Alcance 100.000 de BP total', reward: { currency: 5000 }, completed: false },
                'bp_1m': { name: 'Poder 1M', description: 'Alcance 1.000.000 de BP total', reward: { currency: 10000 }, completed: false },
                'endless_10': { name: 'Desafio 10', description: 'Alcance o n√≠vel 10 no Desafio Infinito', reward: { starFragments: 25 }, completed: false },
                'endless_50': { name: 'Desafio 50', description: 'Alcance o n√≠vel 50 no Desafio Infinito', reward: { starFragments: 100 }, completed: false },
                'endless_100': { name: 'Desafio 100', description: 'Alcance o n√≠vel 100 no Desafio Infinito', reward: { starFragments: 250 }, completed: false }
            },
            dailyRewards: [
                { day: 1, reward: { currency: 100 }, image: 'https://placehold.co/64x64/e0af68/1a1b26?text=$' },
                { day: 2, reward: { starFragments: 5 }, image: 'https://placehold.co/64x64/ffd700/1a1b26?text=‚òÖ' },
                { day: 3, reward: { currency: 200 }, image: 'https://placehold.co/64x64/e0af68/1a1b26?text=$' },
                { day: 4, reward: { items: { exp_potion_1: 3 } }, image: 'https://placehold.co/64x64/00ff00/ffffff?text=EXP' },
                { day: 5, reward: { starFragments: 10 }, image: 'https://placehold.co/64x64/ffd700/1a1b26?text=‚òÖ' },
                { day: 6, reward: { currency: 500 }, image: 'https://placehold.co/64x64/e0af68/1a1b26?text=$' },
                { day: 7, reward: { items: { exp_potion_2: 1, refine_stone_1: 5, skill_tome_1: 2 } }, image: 'https://placehold.co/64x64/bb9af7/1a1b26?text=üéÅ' }
            ]
        };

        // --- GAME STATE ---
        let currentUser = 'player1';
        
        function createDefaultPlayerData() {
            return {
                currency: 1000,
                starFragments: 0,
                characters: {},
                equipment: {},
                pets: { active: null, collection: {} },
                petFragments: {},
                artifacts: { collection: {}, equipped: [], fragments: {} },
                formation: [null, null, null, null, null, null],
                favoriteCharacter: null,
                endlessLevel: 1,
                items: {},
                achievements: {},
                dailyRewards: { lastClaim: null, streak: 0 }
            };
        }

        let playerData = createDefaultPlayerData();
        let battleState = { type: null, playerTeam: [], enemyTeam: [], turnQueue: [], battleSpeed: 1, isBattleOver: false, background: null, stageIndex: null };
        let currentBattleSpeed = 1;
        let battleLoopId = null;
        let isPageVisible = true;


        // --- VISIBILITY API SUPPORT ---
        document.addEventListener('visibilitychange', function() {
            isPageVisible = !document.hidden;
            
            if (isPageVisible) {
                hideBattlePausedIndicator();
                if (battleState.type && !battleState.isBattleOver) {
                    if (!battleLoopId) {
                        runBattleLoop();
                    }
                }
            } else {
                if (battleState.type && !battleState.isBattleOver) {
                    showBattlePausedIndicator();
                }
            }
        });

        function showBattlePausedIndicator() {
            const indicator = document.getElementById('battle-paused-indicator');
            if (indicator) {
                indicator.style.display = 'block';
            }
        }

        function hideBattlePausedIndicator() {
            const indicator = document.getElementById('battle-paused-indicator');
            if (indicator) {
                indicator.style.display = 'none';
            }
        }

        // --- UTILITY FUNCTIONS ---
        function formatNumber(num) { return num.toLocaleString('pt-BR'); }
        function createUniqueId(prefix) { return `${prefix}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`; }
        function getRequiredExp(level) { return Math.floor(50 * Math.pow(1.2, level - 1)); }
        function getRefineCost(refinement) { return Math.max(1, Math.floor(refinement / 2) + 1); }
        function getSkillUpgradeCost(skillLevel) { return Math.max(1, skillLevel * 3); }

        // --- DATA MANAGEMENT ---
        function savePlayerData() { localStorage.setItem(`ala_playerData_${currentUser}`, JSON.stringify(playerData)); }
        function loadPlayerData() {
            const saved = localStorage.getItem(`ala_playerData_${currentUser}`);
            if (saved) {
                const defaultData = createDefaultPlayerData();
                let parsedData = JSON.parse(saved);
                
                // Deep merge to ensure new properties from default are added
                playerData = { ...defaultData, ...parsedData, 
                    pets: { ...defaultData.pets, ...(parsedData.pets || {}) },
                    artifacts: { ...defaultData.artifacts, ...(parsedData.artifacts || {}) },
                };

            }
            updateUI();
        }

        async function handleLogin() {
            const savedUser = localStorage.getItem('ala_currentUser');
            if (savedUser) {
                currentUser = savedUser;
            } else {
                const username = await customPrompt("Digite seu nome de usu√°rio:", "Jogador");
                currentUser = username || 'Jogador';
                localStorage.setItem('ala_currentUser', currentUser);
            }
            document.getElementById('username-display').innerText = currentUser;
            document.getElementById('mobile-username-display').innerText = currentUser;
            
            if (currentUser.toLowerCase() === 'fiore123') {
                document.querySelectorAll('[data-screen="admin"]').forEach(btn => btn.classList.remove('hidden'));
            }
        }

        async function handleLogout() {
            const confirmed = await customConfirm("Tem certeza que deseja sair?");
            if (confirmed) {
                localStorage.removeItem('ala_currentUser');
                window.location.reload();
            }
        }

        // --- ACHIEVEMENT SYSTEM ---
        function checkAchievements() {
            const achievements = GAME_DB.achievements;
            let newAchievements = [];

            if (Object.keys(playerData.characters).length > 0 && !playerData.achievements.first_hero) newAchievements.push('first_hero');

            const maxLevel = Math.max(0, ...Object.values(playerData.characters).map(c => c.level));
            if (maxLevel >= 10 && !playerData.achievements.level_10) newAchievements.push('level_10');
            if (maxLevel >= 50 && !playerData.achievements.level_50) newAchievements.push('level_50');
            if (maxLevel >= 100 && !playerData.achievements.level_100) newAchievements.push('level_100');

            const totalBP = calculateTotalBP();
            if (totalBP >= 10000 && !playerData.achievements.bp_10k) newAchievements.push('bp_10k');
            if (totalBP >= 100000 && !playerData.achievements.bp_100k) newAchievements.push('bp_100k');
            if (totalBP >= 1000000 && !playerData.achievements.bp_1m) newAchievements.push('bp_1m');

            if (playerData.endlessLevel >= 10 && !playerData.achievements.endless_10) newAchievements.push('endless_10');
            if (playerData.endlessLevel >= 50 && !playerData.achievements.endless_50) newAchievements.push('endless_50');
            if (playerData.endlessLevel >= 100 && !playerData.achievements.endless_100) newAchievements.push('endless_100');

            newAchievements.forEach(id => {
                playerData.achievements[id] = true;
                const achievement = achievements[id];
                if (achievement.reward.currency) playerData.currency += achievement.reward.currency;
                if (achievement.reward.starFragments) playerData.starFragments += achievement.reward.starFragments;
                showAchievement(achievement.name, achievement.description);
            });

            if (newAchievements.length > 0) {
                savePlayerData();
                updateUI();
            }
        }

        // --- DAILY REWARDS SYSTEM ---
        function checkDailyRewards() {
            const now = new Date();
            const today = now.toDateString();
            const lastClaim = playerData.dailyRewards.lastClaim;

            if (lastClaim !== today) {
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                
                if (lastClaim === yesterday.toDateString()) {
                    playerData.dailyRewards.streak = Math.min(7, playerData.dailyRewards.streak + 1);
                } else {
                    playerData.dailyRewards.streak = 1;
                }
            }
        }

        function claimDailyReward(day) {
            const now = new Date();
            const today = now.toDateString();
            
            if (playerData.dailyRewards.lastClaim === today) {
                customAlert("Voc√™ j√° coletou a recompensa de hoje!");
                return;
            }

            if (day !== playerData.dailyRewards.streak) {
                customAlert("Voc√™ s√≥ pode coletar a recompensa do dia atual!");
                return;
            }

            const reward = GAME_DB.dailyRewards[day - 1].reward;
            if (reward.currency) playerData.currency += reward.currency;
            if (reward.starFragments) playerData.starFragments += reward.starFragments;
            if (reward.items) {
                Object.entries(reward.items).forEach(([itemId, amount]) => {
                    playerData.items[itemId] = (playerData.items[itemId] || 0) + amount;
                });
            }

            playerData.dailyRewards.lastClaim = today;
            
            if (playerData.dailyRewards.streak >= 7) {
                playerData.dailyRewards.streak = 0;
            }

            savePlayerData();
            updateUI();
            renderDailyRewardsScreen();
            customAlert("Recompensa coletada com sucesso!");
        }

        // --- CHARACTER & EQUIPMENT STATS ---
        function getPetBonus(pPet) {
            if (!pPet) return {};
            const basePet = GAME_DB.pets[pPet.id];
            const bonus = {};
            for (const stat in basePet.baseBonus) {
                bonus[stat] = basePet.baseBonus[stat] + (pPet.stars - 1) * basePet.growthPerStar[stat];
            }
            return bonus;
        }

        function getArtifactBonus(pArtifact) {
            if (!pArtifact) return {};
            const baseArtifact = GAME_DB.artifacts[pArtifact.id];
            const bonus = {};
            // Exponential growth: value = base * (1.07 ^ (level - 1))
            const levelMultiplier = Math.pow(1.07, pArtifact.level - 1);
            for (const stat in baseArtifact.stats) {
                bonus[stat] = baseArtifact.stats[stat] * levelMultiplier;
            }
            return bonus;
        }

        function getTotalArtifactBonus() {
            const totalBonus = {};
            playerData.artifacts.equipped.forEach(instanceId => {
                const pArtifact = playerData.artifacts.collection[instanceId];
                if(pArtifact) {
                    const bonus = getArtifactBonus(pArtifact);
                    Object.entries(bonus).forEach(([stat, value]) => {
                        totalBonus[stat] = (totalBonus[stat] || 0) + value;
                    });
                }
            });
            return totalBonus;
        }

        function getCharacterStats(charInstanceId) {
            const pChar = playerData.characters[charInstanceId];
            if (!pChar) return null;
            const baseChar = GAME_DB.characters[pChar.id];
            const stats = { ...baseChar, crit_chance: 5, crit_damage: 50 }; // Base crit
            
            const levelMultiplier = 1 + (pChar.level - 1) * 0.1;
            ['atk', 'def', 'hp', 'speed'].forEach(stat => {
                stats[stat] = Math.floor((stats[stat] || 0) * levelMultiplier);
            });
            
            Object.entries(pChar.stat_mods || {}).forEach(([stat, value]) => {
                stats[stat] = value;
            });
            
            Object.entries(pChar.refine_bonus_stats || {}).forEach(([stat, value]) => {
                stats[stat] += value;
            });
            
            Object.values(pChar.equipped || {}).forEach(eqInstanceId => {
                const eqStats = getEquipmentStats(eqInstanceId);
                if (eqStats) {
                    Object.entries(eqStats).forEach(([stat, value]) => {
                        stats[stat] = (stats[stat] || 0) + value;
                    });
                }
            });
            
            // Apply Pet Bonus (as percentage)
            const activePetInstanceId = playerData.pets?.active;
            if (activePetInstanceId && playerData.pets.collection[activePetInstanceId]) {
                const pPet = playerData.pets.collection[activePetInstanceId];
                const petBonus = getPetBonus(pPet);

                if (petBonus) {
                    if (petBonus.atk_percent) stats.atk = Math.floor(stats.atk * (1 + petBonus.atk_percent));
                    if (petBonus.def_percent) stats.def = Math.floor(stats.def * (1 + petBonus.def_percent));
                    if (petBonus.hp_percent) stats.hp = Math.floor(stats.hp * (1 + petBonus.hp_percent));
                    if (petBonus.speed_percent) stats.speed = Math.floor(stats.speed * (1 + petBonus.speed_percent));
                }
            }

            // Apply Artifact Bonus (as percentage and flat)
            const artifactBonus = getTotalArtifactBonus();
            Object.entries(artifactBonus).forEach(([stat, value]) => {
                 if (stat.includes('_percent')) {
                    const baseStat = stat.replace('_percent', '');
                    stats[baseStat] = Math.floor(stats[baseStat] * (1 + value / 100));
                 } else {
                    stats[stat] = (stats[stat] || 0) + value;
                 }
            });

            return stats;
        }

        function getEquipmentStats(eqInstanceId) {
            const pEq = playerData.equipment[eqInstanceId];
            if (!pEq) return null;
            const baseEq = GAME_DB.equipment[pEq.id];
            const stats = { ...baseEq.stats };
            
            const levelMultiplier = 1 + (pEq.level - 1) * 0.05;
            Object.keys(stats).forEach(stat => {
                stats[stat] = Math.floor(stats[stat] * levelMultiplier);
            });
            
            Object.entries(pEq.stat_mods || {}).forEach(([stat, value]) => {
                stats[stat] = value;
            });
            
            Object.entries(pEq.refine_bonus_stats || {}).forEach(([stat, value]) => {
                stats[stat] += value;
            });
            
            return stats;
        }

        function getCombatantStats(combatant) {
            return combatant.isPlayer ? getCharacterStats(combatant.instanceId) : combatant.stats;
        }

        function calculateBP(charInstanceId) {
            const stats = getCharacterStats(charInstanceId);
            if (!stats) return 0;
            return Math.floor(stats.atk * 2 + stats.def * 1.5 + stats.hp * 0.8 + stats.speed * 1.2 + (stats.crit_chance || 0) * 10 + (stats.crit_damage || 0) * 5);
        }

        function calculateTotalBP() {
            return playerData.formation
                .filter(id => id)
                .reduce((total, id) => total + calculateBP(id), 0);
        }

        function createCharacterCard(charInstanceId, showFormationButton = false) {
            const pChar = playerData.characters[charInstanceId];
            if (!pChar) return '';
            const baseChar = GAME_DB.characters[pChar.id];
            if (!baseChar) return '';
            const tier = Math.min(5, Math.ceil(pChar.quality / 5));
            const isInFormation = playerData.formation.includes(charInstanceId);
            
            return `
                <div class="relative text-center border-2 rounded-lg p-2 rarity-${baseChar.rarity} quality-tier-${tier} cursor-pointer hover:scale-105 transition-transform" data-char-instance-id="${charInstanceId}">
                    ${baseChar.rarity === 5 ? '<div class="absolute inset-0 shine rounded-lg"></div>' : ''}
                    <img src="${baseChar.image}" alt="${baseChar.name}" class="mx-auto rounded mb-1 h-20 w-16 object-cover">
                    <p class="font-semibold text-xs truncate">${baseChar.name}</p>
                    <p class="text-xs text-gray-300">Nv.${pChar.level}</p>
                    <p class="h-4 text-xs">${renderQualityStars(pChar.quality)}</p>
                    <div class="text-xs font-bold text-yellow-300 mb-1">BP ${formatNumber(calculateBP(charInstanceId))}</div>
                    ${showFormationButton ? `
                        <button class="formation-btn" onclick="event.stopPropagation(); openFormationPlacementModal('${charInstanceId}')">
                            ${isInFormation ? 'Remover' : 'Adicionar'}
                        </button>
                    ` : ''}
                </div>
            `;
        }

        // --- FORMATION SYSTEM ---
        function openFormationPlacementModal(charInstanceId) {
            const modal = document.getElementById('formation-placement-modal');
            const pChar = playerData.characters[charInstanceId];
            const baseChar = GAME_DB.characters[pChar.id];
            const isInFormation = playerData.formation.includes(charInstanceId);
            
            if (isInFormation) {
                const index = playerData.formation.indexOf(charInstanceId);
                playerData.formation[index] = null;
                savePlayerData();
                updateUI();
                return;
            }
            
            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-md w-full">
                    <h2 class="text-xl font-bold mb-4 text-center">Escolha a Posi√ß√£o</h2>
                    <div class="text-center mb-4">
                        <img src="${baseChar.image}" alt="${baseChar.name}" class="mx-auto rounded h-16 w-12 object-cover border-2 rarity-${baseChar.rarity}">
                        <p class="font-semibold mt-1">${baseChar.name}</p>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        ${playerData.formation.map((charId, index) => `
                            <div class="formation-slot bg-gray-700 border-2 border-dashed border-gray-500 rounded-lg p-2 text-center cursor-pointer hover:border-primary transition-colors ${charId ? 'occupied' : ''}" 
                                 onclick="placeCharacterInFormation('${charInstanceId}', ${index})">
                                ${charId ? `
                                    <img src="${GAME_DB.characters[playerData.characters[charId].id].image}" class="w-8 h-10 mx-auto object-cover rounded">
                                    <p class="text-xs mt-1 truncate">${GAME_DB.characters[playerData.characters[charId].id].name}</p>
                                ` : `
                                    <div class="w-8 h-10 mx-auto bg-gray-600 rounded flex items-center justify-center">
                                        <span class="text-xs">+</span>
                                    </div>
                                    <p class="text-xs mt-1">Slot ${index + 1}</p>
                                `}
                            </div>
                        `).join('')}
                    </div>
                    <button onclick="document.getElementById('formation-placement-modal').classList.add('hidden')" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">
                        Cancelar
                    </button>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function placeCharacterInFormation(charInstanceId, slotIndex) {
            const currentCharInSlot = playerData.formation[slotIndex];
            const currentIndex = playerData.formation.indexOf(charInstanceId);

            if (currentIndex !== -1) {
                playerData.formation[currentIndex] = currentCharInSlot || null;
            }
            
            playerData.formation[slotIndex] = charInstanceId;
            savePlayerData();
            updateUI();
            document.getElementById('formation-placement-modal').classList.add('hidden');
        }

        // --- RECRUIT SYSTEM WITH DUPLICATE HANDLING ---
        async function recruit(type, amount) {
            const costMap = { 'hero': 150, 'pet': 120, 'equipment': 100, 'artifact': 250 };
            const cost = costMap[type] * amount;
            
            if (playerData.currency < cost) { 
                await customAlert("Cristais insuficientes!"); 
                return; 
            }
            
            playerData.currency -= cost;
            const results = [];
            const db = type === 'hero' ? GAME_DB.characters : type === 'pet' ? GAME_DB.pets : type === 'artifact' ? GAME_DB.artifacts : GAME_DB.equipment;
            const allIds = Object.keys(db);

            for (let i = 0; i < amount; i++) {
                const rand = Math.random() * 100;
                let chosenRarity = (rand < 3) ? 5 : (rand < 15) ? 4 : (rand < 40) ? 3 : (rand < 75) ? 2 : 1;
                let potentialItems = allIds.filter(id => db[id].rarity === chosenRarity);
                if (potentialItems.length === 0) { 
                    potentialItems = allIds.filter(id => db[id].rarity >= 1); // Fallback
                }
                const recruitedId = potentialItems[Math.floor(Math.random() * potentialItems.length)];
                
                if (type === 'pet') {
                    const existingPet = Object.values(playerData.pets.collection).find(pet => pet.id === recruitedId);
                    if (existingPet) {
                        const fragmentsGained = db[recruitedId].rarity * 5;
                        playerData.petFragments[recruitedId] = (playerData.petFragments[recruitedId] || 0) + fragmentsGained;
                        results.push({ type: 'pet_fragment', id: recruitedId, fragments: fragmentsGained });
                    } else {
                        const newInstanceId = createUniqueId('pet');
                        playerData.pets.collection[newInstanceId] = {
                            id: recruitedId,
                            stars: 1
                        };
                        results.push({ type: 'pet', instanceId: newInstanceId });
                    }
                } else if (type === 'hero') {
                    const existingChar = Object.values(playerData.characters).find(char => char.id === recruitedId);
                    if (existingChar) {
                        const baseChar = db[recruitedId];
                        const fragmentsGained = baseChar.rarity * 10;
                        playerData.starFragments += fragmentsGained;
                        results.push({ type: 'fragment', id: recruitedId, fragments: fragmentsGained });
                    } else {
                        const newInstanceId = createUniqueId('char');
                        playerData.characters[newInstanceId] = { 
                            id: recruitedId, level: 1, exp: 0, refinement: 0, quality: 1, 
                            skillLevel: 1, equipped: {}, stat_mods: {}, refine_bonus_stats: {} 
                        };
                        results.push({ type: 'character', instanceId: newInstanceId });
                    }
                } else if (type === 'artifact') {
                    const existingArtifact = Object.values(playerData.artifacts.collection).find(art => art.id === recruitedId);
                    if (existingArtifact) {
                        const fragmentsGained = db[recruitedId].rarity * 10;
                         playerData.artifacts.fragments[recruitedId] = (playerData.artifacts.fragments[recruitedId] || 0) + fragmentsGained;
                        results.push({ type: 'artifact_fragment', id: recruitedId, fragments: fragmentsGained });
                    } else {
                        const newInstanceId = createUniqueId('art');
                        playerData.artifacts.collection[newInstanceId] = {
                            id: recruitedId,
                            level: 1
                        };
                        results.push({ type: 'artifact', instanceId: newInstanceId });
                    }
                } else { // equipment
                    const newInstanceId = createUniqueId('eq');
                    playerData.equipment[newInstanceId] = { 
                        id: recruitedId, level: 1, exp: 0, refinement: 0, quality: 1, 
                        equippedTo: null, stat_mods: {}, refine_bonus_stats: {} 
                    };
                    results.push({ type: 'equipment', instanceId: newInstanceId });
                }
            }
            
            displayRecruitResults(results);
            savePlayerData();
            updateUI();
            checkAchievements();
        }

        function displayRecruitResults(results) {
            const modal = document.getElementById('recruit-modal');
            
            const content = results.map(result => {
                if (result.type === 'character') {
                    return createCharacterCard(result.instanceId);
                } else if (result.type === 'fragment') {
                    const baseChar = GAME_DB.characters[result.id];
                    return `
                        <div class="relative text-center border-2 rounded-lg p-2 border-yellow-400 star-fragment">
                            <img src="${baseChar.image}" alt="${baseChar.name}" class="mx-auto rounded mb-1 h-16 w-16 object-cover opacity-50">
                            <p class="font-semibold text-xs truncate">${baseChar.name}</p>
                            <p class="text-yellow-300 font-bold text-sm">+${result.fragments} ‚≠ê</p>
                            <p class="text-xs text-yellow-200">Fragmentos de Estrela</p>
                        </div>
                    `;
                } else if (result.type === 'pet') {
                    const pPet = playerData.pets.collection[result.instanceId];
                    const basePet = GAME_DB.pets[pPet.id];
                    return `
                        <div class="relative text-center border-2 rounded-lg p-2 rarity-${basePet.rarity}">
                            <img src="${basePet.image}" alt="${basePet.name}" class="mx-auto rounded-full mb-1 h-16 w-16 object-cover">
                            <p class="font-semibold text-xs truncate">${basePet.name}</p>
                            <p class="text-yellow-300">${renderPetStars(pPet.stars)}</p>
                        </div>
                    `;
                } else if (result.type === 'pet_fragment') {
                     const basePet = GAME_DB.pets[result.id];
                    return `
                        <div class="relative text-center border-2 rounded-lg p-2 border-green-400">
                            <img src="${basePet.image}" alt="${basePet.name}" class="mx-auto rounded-full mb-1 h-16 w-16 object-cover opacity-50">
                            <p class="font-semibold text-xs truncate">${basePet.name}</p>
                            <p class="text-green-300 font-bold text-sm">+${result.fragments} Fragmentos</p>
                        </div>
                    `;
                } else if (result.type === 'artifact') {
                    const pArt = playerData.artifacts.collection[result.instanceId];
                    const baseArt = GAME_DB.artifacts[pArt.id];
                    return `
                        <div class="relative text-center border-2 rounded-lg p-2 rarity-${baseArt.rarity}">
                            <img src="${baseArt.image}" alt="${baseArt.name}" class="mx-auto rounded-full mb-1 h-16 w-16 object-cover">
                            <p class="font-semibold text-xs truncate">${baseArt.name}</p>
                            <p class="text-yellow-300">N√≠vel ${pArt.level}</p>
                        </div>
                    `;
                } else if (result.type === 'artifact_fragment') {
                    const baseArt = GAME_DB.artifacts[result.id];
                    return `
                        <div class="relative text-center border-2 rounded-lg p-2 border-blue-400">
                            <img src="${baseArt.image}" alt="${baseArt.name}" class="mx-auto rounded-full mb-1 h-16 w-16 object-cover opacity-50">
                            <p class="font-semibold text-xs truncate">${baseArt.name}</p>
                            <p class="text-blue-300 font-bold text-sm">+${result.fragments} Fragmentos</p>
                        </div>
                    `;
                } else { // equipment
                    const pEq = playerData.equipment[result.instanceId];
                    const baseEq = GAME_DB.equipment[pEq.id];
                    return `
                        <div class="relative text-center border-2 rounded-lg p-2 rarity-${baseEq.rarity}">
                            <img src="${baseEq.image}" alt="${baseEq.name}" class="mx-auto rounded mb-1 h-16 w-16">
                            <p class="font-semibold text-xs truncate">${baseEq.name}</p>
                        </div>
                    `;
                }
            }).join('');
            
            modal.innerHTML = `
                <div class="bg-[#24283b] p-6 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                    <h2 class="text-2xl font-bold mb-4 text-center">Resultados da Invoca√ß√£o</h2>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-4">${content}</div>
                    <button id="recruit-modal-close" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Fechar</button>
                </div>
            `;
            modal.classList.remove('hidden');
            document.getElementById('recruit-modal-close').onclick = () => modal.classList.add('hidden');
        }


        // --- BATTLE SYSTEM ---
        async function startBattle(stageIndex) {
            if (playerData.formation.filter(id => id).length === 0) {
                await customAlert("Sua forma√ß√£o est√° vazia! V√° para a tela de Her√≥is para adicionar her√≥is √† forma√ß√£o.");
                return;
            }
            
            const stage = GAME_DB.stages[stageIndex];
            const enemyPool = Object.keys(GAME_DB.enemies);
            const enemyCount = Math.min(3, 1 + Math.floor(stageIndex / 2));
            const enemies = [];
            
            for (let i = 0; i < enemyCount; i++) {
                const baseId = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                const baseEnemy = GAME_DB.enemies[baseId];
                const scaledStats = {};
                for (const stat in baseEnemy) {
                    if (typeof baseEnemy[stat] === 'number') {
                        scaledStats[stat] = Math.floor(baseEnemy[stat] * (1 + stageIndex * 0.2));
                    } else {
                        scaledStats[stat] = baseEnemy[stat];
                    }
                }
                enemies.push({
                    instanceId: `stage-${baseId}-${i}`,
                    baseId: baseId,
                    stats: scaledStats,
                    currentHp: scaledStats.hp,
                    isPlayer: false
                });
            }
            
            battleState = {
                type: 'stage',
                stageIndex: stageIndex,
                playerTeam: playerData.formation.filter(id => id).map(id => ({ 
                    instanceId: id, 
                    currentHp: getCharacterStats(id).hp, 
                    isPlayer: true, 
                    skillCooldownTimer: 0 
                })),
                enemyTeam: enemies,
                turnQueue: [], 
                battleSpeed: currentBattleSpeed, 
                isBattleOver: false,
                background: stage.background
            };
            
            renderBattleArena(stage);
            switchScreen('battle-arena');
            setTimeout(runBattleLoop, 1000);
        }
        
        function generateEndlessEnemies(level) {
            const enemyPool = Object.keys(GAME_DB.enemies);
            const enemyCount = Math.min(5, 1 + Math.floor(level / 5));
            const enemies = [];
            for (let i = 0; i < enemyCount; i++) {
                const baseId = enemyPool[Math.floor(Math.random() * enemyPool.length)];
                const baseEnemy = GAME_DB.enemies[baseId];
                const scaledStats = {};
                for (const stat in baseEnemy) {
                    if (typeof baseEnemy[stat] === 'number') {
                        scaledStats[stat] = Math.floor(baseEnemy[stat] * (1 + (level - 1) * 0.15));
                    } else {
                        scaledStats[stat] = baseEnemy[stat];
                    }
                }
                enemies.push({
                    instanceId: `endless-${baseId}-${i}`,
                    baseId: baseId,
                    stats: scaledStats,
                    currentHp: scaledStats.hp,
                    isPlayer: false
                });
            }
            return enemies;
        }

        async function startEndlessBattle() {
            if (playerData.formation.filter(id => id).length === 0) {
                await customAlert("Sua forma√ß√£o est√° vazia! V√° para a tela de Her√≥is para adicionar her√≥is √† forma√ß√£o.");
                return;
            }
            
            const enemies = generateEndlessEnemies(playerData.endlessLevel);
            const mockStage = {
                name: `Desafio Infinito - N√≠vel ${playerData.endlessLevel}`,
                background: GAME_DB.stages[Math.floor(Math.random() * GAME_DB.stages.length)].background
            };
            battleState = {
                type: 'endless',
                playerTeam: playerData.formation.filter(id => id).map(id => ({ instanceId: id, currentHp: getCharacterStats(id).hp, isPlayer: true, skillCooldownTimer: 0 })),
                enemyTeam: enemies,
                turnQueue: [], 
                battleSpeed: currentBattleSpeed, 
                isBattleOver: false,
                background: mockStage.background
            };
            
            renderBattleArena(mockStage);
            switchScreen('battle-arena');
            setTimeout(runBattleLoop, 1000);
        }
        
        function continueEndlessBattle() {
            playerData.endlessLevel++;
            const reward = 50 + (playerData.endlessLevel - 1) * 10;
            playerData.currency += reward;
            savePlayerData();
            updateUI();
            checkAchievements();

            const enemies = generateEndlessEnemies(playerData.endlessLevel);
            const mockStage = {
                name: `Desafio Infinito - N√≠vel ${playerData.endlessLevel}`,
                background: battleState.background
            };
            battleState = {
                type: 'endless',
                playerTeam: playerData.formation.filter(id => id).map(id => ({ instanceId: id, currentHp: getCharacterStats(id).hp, isPlayer: true, skillCooldownTimer: 0 })),
                enemyTeam: enemies,
                turnQueue: [],
                battleSpeed: currentBattleSpeed,
                isBattleOver: false,
                background: battleState.background
            };
            
            if(document.getElementById('battle-arena-screen').classList.contains('active')) {
                renderBattleArena(mockStage);
            }
            
            setTimeout(runBattleLoop, 1000);
        }

        async function runBattleLoop() {
            if (battleLoopId) clearTimeout(battleLoopId);
            if (battleState.isBattleOver || !isPageVisible) return;

            if (battleState.turnQueue.length === 0) {
                const allCombatants = [...battleState.playerTeam, ...battleState.enemyTeam].filter(c => c.currentHp > 0);
                allCombatants.sort((a, b) => getCombatantStats(b).speed - getCombatantStats(a).speed);
                battleState.turnQueue = allCombatants;
            }

            const attacker = battleState.turnQueue.shift();
            if (attacker && attacker.currentHp > 0) {
                const canUseSkill = attacker.isPlayer && attacker.skillCooldownTimer <= 0;
                
                if (canUseSkill) {
                     await useSkill(attacker);
                } else {
                    const targetPool = (attacker.isPlayer ? battleState.enemyTeam : battleState.playerTeam).filter(c => c.currentHp > 0);
                    if (targetPool.length > 0) {
                        const target = targetPool[Math.floor(Math.random() * targetPool.length)];
                        await performAttack(attacker, target);
                    }
                }
                
                if(attacker.isPlayer) {
                    attacker.skillCooldownTimer = Math.max(0, attacker.skillCooldownTimer - 1);
                }
            }
            
            const isVictory = battleState.enemyTeam.every(c => c.currentHp <= 0);
            const isDefeat = battleState.playerTeam.every(c => c.currentHp <= 0);

            if (isVictory || isDefeat) {
                battleState.isBattleOver = true;
                battleLoopId = setTimeout(() => showBattleResult(isVictory), 1000 / battleState.battleSpeed);
            } else {
                battleLoopId = setTimeout(runBattleLoop, 2000 / battleState.battleSpeed);
            }
        }
        
        async function useSkill(attacker) {
            const pChar = playerData.characters[attacker.instanceId];
            const baseChar = GAME_DB.characters[pChar.id];
            const skill = baseChar.skill;
            const attackerStats = getCharacterStats(attacker.instanceId);
            
            const attackerElement = document.querySelector(`[data-combatant-id="${attacker.instanceId}"]`);
            if (attackerElement) {
                attackerElement.classList.add('skill-cast');
                setTimeout(() => attackerElement.classList.remove('skill-cast'), 500);
            }
            
            showSkillName(attacker, skill.name);

            // Simplified skill logic for demonstration
            switch(skill.type) {
                case 'damage': {
                    const target = battleState.enemyTeam.filter(c => c.currentHp > 0)[0];
                    if(target) {
                         let damage = attackerStats.atk * skill.power * (1 + (pChar.skillLevel-1) * 0.1);
                         damage = Math.floor(damage);
                         target.currentHp = Math.max(0, target.currentHp - damage);
                         updateHealthBar(target);
                         showDamageNumber(target, damage, 'damage');
                    }
                    break;
                }
                case 'heal': {
                    let lowestHpAlly = battleState.playerTeam.filter(c => c.currentHp > 0).sort((a, b) => a.currentHp - b.currentHp)[0];
                    if(lowestHpAlly) {
                        const allyStats = getCharacterStats(lowestHpAlly.instanceId);
                        let healAmount = attackerStats.atk * skill.power * (1 + (pChar.skillLevel-1) * 0.1);
                        healAmount = Math.floor(healAmount);
                        lowestHpAlly.currentHp = Math.min(allyStats.hp, lowestHpAlly.currentHp + healAmount);
                        updateHealthBar(lowestHpAlly);
                        showDamageNumber(lowestHpAlly, healAmount, 'heal');
                    }
                    break;
                }
            }
            
            attacker.skillCooldownTimer = skill.cooldown;
            return Promise.resolve();
        }
        
        function performAttack(attacker, target) {
            return new Promise(resolve => {
                const attackerStats = getCombatantStats(attacker);
                const targetStats = getCombatantStats(target);
                const attackerElement = document.querySelector(`[data-combatant-id="${attacker.instanceId}"]`);
                
                if(!attackerElement) {
                    resolve();
                    return;
                }

                attackerElement.classList.add('attacking', attacker.isPlayer ? 'player' : 'enemy');

                setTimeout(() => {
                    attackerElement.classList.remove('attacking', 'player', 'enemy');
                    
                    let damage = Math.max(1, attackerStats.atk - (targetStats.def / 2));
                    damage = Math.floor(damage * (Math.random() * 0.2 + 0.9));

                    target.currentHp = Math.max(0, target.currentHp - damage);
                    updateHealthBar(target);
                    showDamageNumber(target, damage, 'damage');
                    
                    const targetElement = document.querySelector(`[data-combatant-id="${target.instanceId}"]`);
                    if (target.currentHp <= 0 && targetElement) {
                         targetElement.classList.add('dead');
                    }
                    resolve();
                }, 300 / battleState.battleSpeed);
            });
        }
        
        // --- MODAL & DETAIL LOGIC ---
        function setFavoriteCharacter(charInstanceId) {
            playerData.favoriteCharacter = charInstanceId;
            savePlayerData();
            updateUI();
            customAlert("Her√≥i favoritado com sucesso!");
            document.getElementById('character-detail-modal').classList.add('hidden');
        }

        function handleUnequipAction(charInstanceId, slotType) {
            const pChar = playerData.characters[charInstanceId];
            const eqInstanceId = pChar.equipped[slotType];

            if (eqInstanceId && playerData.equipment[eqInstanceId]) {
                playerData.equipment[eqInstanceId].equippedTo = null;
            }
            delete pChar.equipped[slotType];
            
            openCharacterDetailModal(charInstanceId);
            savePlayerData();
            updateUI();
        }

        function equipItem(charInstanceId, eqInstanceId, slotType) {
            const pEq = playerData.equipment[eqInstanceId];
            if(pEq.equippedTo) {
                const otherChar = playerData.characters[pEq.equippedTo];
                if(otherChar) {
                    Object.keys(otherChar.equipped).forEach(s => {
                        if(otherChar.equipped[s] === eqInstanceId) delete otherChar.equipped[s];
                    });
                }
            }

            const charToUpdate = playerData.characters[charInstanceId];
            const currentItemInSlot = charToUpdate.equipped[slotType];
            if(currentItemInSlot) {
                playerData.equipment[currentItemInSlot].equippedTo = null;
            }

            charToUpdate.equipped[slotType] = eqInstanceId;
            pEq.equippedTo = charInstanceId;

            document.getElementById('equip-select-modal').classList.add('hidden');
            openCharacterDetailModal(charInstanceId); 
            savePlayerData();
            updateUI();
        }

        function handleEquipAction(charInstanceId, slotType) {
            const modal = document.getElementById('equip-select-modal');
            const availableEquip = Object.entries(playerData.equipment)
                .filter(([id, eq]) => !eq.equippedTo && GAME_DB.equipment[eq.id].type === slotType);

            let contentHTML = '<p class="col-span-full text-center text-gray-400">Nenhum equipamento dispon√≠vel deste tipo.</p>';
            if (availableEquip.length > 0) {
                contentHTML = availableEquip.map(([eqInstanceId, pEq]) => {
                    const baseEq = GAME_DB.equipment[pEq.id];
                    return `
                        <div onclick="equipItem('${charInstanceId}', '${eqInstanceId}', '${slotType}')" class="bg-black/40 p-2 rounded-lg text-center border-2 rarity-${baseEq.rarity} cursor-pointer hover:bg-primary/30">
                            <img src="${baseEq.image}" alt="${baseEq.name}" class="w-16 h-16 mx-auto rounded">
                            <p class="text-xs font-semibold mt-1 truncate">${baseEq.name}</p>
                            <p class="text-xs text-gray-300">
                                ${Object.entries(getEquipmentStats(eqInstanceId)).map(([stat, val]) => `${stat.toUpperCase()}: +${val}`).join(', ')}
                            </p>
                        </div>`;
                }).join('');
            }

            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-xl w-full max-h-[90vh] overflow-y-auto">
                    <h2 class="text-xl font-bold mb-4">Selecione um Equipamento (${slotType})</h2>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        ${contentHTML}
                    </div>
                    <button onclick="document.getElementById('equip-select-modal').classList.add('hidden')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Cancelar</button>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function renderQualityStars(quality) {
            if (quality <= 0) return '';
            const tier = Math.min(5, Math.ceil(quality / 5));
            const starsInTier = quality % 5 === 0 ? 5 : quality % 5;
            const color = QualityTiers[tier].color;
            return `<span style="color: ${color}; text-shadow: 0 0 5px ${color};">${'‚òÖ'.repeat(starsInTier)}</span>`;
        }
        
        function renderPetStars(stars) {
            if (stars <= 5) {
                return '‚òÖ'.repeat(stars);
            } else {
                return '‚òÖ'.repeat(5) + ` <span class="text-sm text-yellow-200 font-bold align-middle">+${stars - 5}</span>`;
            }
        }

        function getSkillDescription(charInstanceId) {
            const pChar = playerData.characters[charInstanceId];
            if (!pChar) return '';
            const baseChar = GAME_DB.characters[pChar.id];
            const skill = baseChar.skill;
            
            let finalPower = skill.power * (1 + (pChar.skillLevel - 1) * 0.1);
            
            return skill.description.replace('{power}', Math.round(finalPower * 100));
        }

        function openCharacterDetailModal(charInstanceId) {
            const modal = document.getElementById('character-detail-modal');
            const pChar = playerData.characters[charInstanceId];
            if (!pChar) return;
            const baseChar = GAME_DB.characters[pChar.id];
            const stats = getCharacterStats(charInstanceId);
            const isFavorite = playerData.favoriteCharacter === charInstanceId;
            const requiredExp = getRequiredExp(pChar.level);
            const tier = Math.min(5, Math.ceil(pChar.quality / 5));

            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-3xl w-full max-h-[90vh] overflow-y-auto relative border-2 border-primary shadow-lg shadow-primary/20">
                    <button onclick="document.getElementById('character-detail-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-red-600 rounded-full h-8 w-8 font-bold z-10">X</button>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-1 text-center">
                            <img src="${baseChar.image}" alt="${baseChar.name}" class="rounded-lg w-full rarity-${baseChar.rarity} border-4 quality-tier-${tier}">
                            <h2 class="text-2xl font-bold mt-2">${baseChar.name}</h2>
                            <p class="h-6">${renderQualityStars(pChar.quality)}</p>
                            <p class="text-xl font-bold text-yellow-300">BP ${formatNumber(calculateBP(charInstanceId))}</p>
                            <button ${isFavorite ? 'disabled' : ''} onclick="setFavoriteCharacter('${charInstanceId}')" class="mt-2 w-full font-bold py-2 px-4 rounded ${isFavorite ? 'bg-yellow-500 cursor-not-allowed' : 'bg-yellow-400 hover:bg-yellow-600 text-black'}">
                                ${isFavorite ? '‚òÖ Favorito' : 'Definir Favorito'}
                            </button>
                        </div>
                        <div class="md:col-span-2">
                            <div class="grid grid-cols-2 gap-4 mb-4">
                                <div>
                                    <h3 class="font-bold mb-2">Atributos</h3>
                                    <p>ATK: ${stats.atk}</p>
                                    <p>DEF: ${stats.def}</p>
                                    <p>HP: ${stats.hp}</p>
                                    <p>VEL: ${stats.speed}</p>
                                    <p>CRIT%: ${stats.crit_chance.toFixed(1)}</p>
                                    <p>CRIT DMG: ${stats.crit_damage.toFixed(1)}%</p>
                                </div>
                                <div>
                                    <h3 class="font-bold mb-2">Progress√£o</h3>
                                    <p>N√≠vel: ${pChar.level}</p>
                                    <div class="progress-bar-bg h-2 mb-1">
                                        <div class="progress-bar-fill h-full" style="width: ${(pChar.exp / requiredExp) * 100}%"></div>
                                    </div>
                                    <p class="text-xs">EXP: ${pChar.exp}/${requiredExp}</p>
                                    <p>Refinamento: +${pChar.refinement}</p>
                                    <p>Qualidade: ${pChar.quality}</p>
                                    <p>N√≠vel da Skill: ${pChar.skillLevel}</p>
                                </div>
                            </div>
                            <div class="mb-4">
                                <h3 class="font-bold mb-2">Habilidade: ${baseChar.skill.name}</h3>
                                <p class="text-sm text-gray-300">${getSkillDescription(charInstanceId)}</p>
                                <p class="text-xs text-gray-400 mt-1">Cooldown: ${baseChar.skill.cooldown} turnos</p>
                            </div>
                            <div>
                                <h3 class="font-bold mb-2">Equipamentos</h3>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-2">
                                    ${EQUIP_SLOTS.map(slot => {
                                        const eqInstanceId = pChar.equipped[slot];
                                        const hasEquip = eqInstanceId && playerData.equipment[eqInstanceId];
                                        return `
                                            <div class="bg-black/40 p-2 rounded text-center border border-gray-600">
                                                <p class="text-xs font-semibold mb-1">${slot}</p>
                                                ${hasEquip ? `
                                                    <img src="${GAME_DB.equipment[playerData.equipment[eqInstanceId].id].image}" class="w-8 h-8 mx-auto mb-1">
                                                    <p class="text-xs truncate">${GAME_DB.equipment[playerData.equipment[eqInstanceId].id].name}</p>
                                                    <button onclick="handleUnequipAction('${charInstanceId}', '${slot}')" class="text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded mt-1">Desequipar</button>
                                                ` : `
                                                    <div class="w-8 h-8 mx-auto mb-1 bg-gray-600 rounded flex items-center justify-center">
                                                        <span class="text-xs">+</span>
                                                    </div>
                                                    <button onclick="handleEquipAction('${charInstanceId}', '${slot}')" class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded">Equipar</button>
                                                `}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="mt-4 flex gap-2">
                                <button onclick="openUpgradeModal('character', '${charInstanceId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Melhorar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function openEquipmentDetailModal(eqInstanceId) {
            const modal = document.getElementById('equipment-detail-modal');
            const pEq = playerData.equipment[eqInstanceId];
            if (!pEq) return;
            const baseEq = GAME_DB.equipment[pEq.id];
            const stats = getEquipmentStats(eqInstanceId);
            const requiredExp = getRequiredExp(pEq.level);
            const tier = Math.min(5, Math.ceil(pEq.quality / 5));

            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto relative border-2 border-primary shadow-lg shadow-primary/20">
                    <button onclick="document.getElementById('equipment-detail-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-red-600 rounded-full h-8 w-8 font-bold z-10">X</button>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="text-center">
                            <img src="${baseEq.image}" alt="${baseEq.name}" class="rounded-lg w-32 h-32 mx-auto rarity-${baseEq.rarity} border-4 quality-tier-${tier}">
                            <h2 class="text-xl font-bold mt-2">${baseEq.name}</h2>
                            <p class="text-sm text-gray-400">${baseEq.type}</p>
                            <p class="h-6">${renderQualityStars(pEq.quality)}</p>
                            <p class="text-sm ${pEq.equippedTo ? 'text-green-400' : 'text-gray-400'}">
                                ${pEq.equippedTo ? `Equipado em ${GAME_DB.characters[playerData.characters[pEq.equippedTo].id].name}` : 'N√£o equipado'}
                            </p>
                        </div>
                        <div>
                            <div class="mb-4">
                                <h3 class="font-bold mb-2">Atributos</h3>
                                ${Object.entries(stats).map(([stat, value]) => `<p>${stat.toUpperCase()}: +${value}</p>`).join('')}
                            </div>
                            <div class="mb-4">
                                <h3 class="font-bold mb-2">Progress√£o</h3>
                                <p>N√≠vel: ${pEq.level}</p>
                                <div class="progress-bar-bg h-2 mb-1">
                                    <div class="progress-bar-fill h-full" style="width: ${(pEq.exp / requiredExp) * 100}%"></div>
                                </div>
                                <p class="text-xs">EXP: ${pEq.exp}/${requiredExp}</p>
                                <p>Refinamento: +${pEq.refinement}</p>
                                <p>Qualidade: ${pEq.quality}</p>
                            </div>
                            <button onclick="openUpgradeModal('equipment', '${eqInstanceId}')" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Melhorar</button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function openUpgradeModal(type, instanceId) {
            const modal = document.getElementById('upgrade-modal');
            const target = type === 'character' ? playerData.characters[instanceId] : playerData.equipment[instanceId];
            const baseData = type === 'character' ? GAME_DB.characters[target.id] : GAME_DB.equipment[target.id];
            
            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-md w-full">
                    <h2 class="text-xl font-bold mb-4">Melhorar ${baseData.name}</h2>
                    <div class="space-y-4">
                        <div class="bg-black/40 p-3 rounded">
                            <h3 class="font-semibold mb-2">N√≠vel (${target.level})</h3>
                            <p class="text-sm text-gray-400 mb-2">Use po√ß√µes de EXP para aumentar o n√≠vel</p>
                            <div class="flex gap-2">
                                <select id="upgrade-level-item" class="bg-gray-700 text-white p-1 rounded flex-1">
                                    <option value="exp_potion_1">Po√ß√£o Pequena (${playerData.items.exp_potion_1 || 0})</option>
                                    <option value="exp_potion_2">Po√ß√£o Grande (${playerData.items.exp_potion_2 || 0})</option>
                                </select>
                                <input id="upgrade-level-amount" type="number" value="1" min="1" class="bg-gray-700 text-white p-1 rounded w-16">
                                <button onclick="upgradeTarget('${type}', '${instanceId}', 'level')" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded">Usar</button>
                            </div>
                        </div>
                        <div class="bg-black/40 p-3 rounded">
                            <h3 class="font-semibold mb-2">Refinamento (+${target.refinement})</h3>
                            <p class="text-sm text-gray-400 mb-2">Custo: ${getRefineCost(target.refinement)} Pedras de Refinamento</p>
                            <p class="text-xs text-yellow-400 mb-2">A cada 5 refinamentos, ganha um b√¥nus aleat√≥rio!</p>
                            <button onclick="upgradeTarget('${type}', '${instanceId}', 'refine')" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-1 rounded">Refinar (${playerData.items.refine_stone_1 || 0})</button>
                        </div>
                        <div class="bg-black/40 p-3 rounded">
                            <h3 class="font-semibold mb-2">Qualidade (${target.quality})</h3>
                            <p class="text-sm text-gray-400 mb-2">Custo: ${target.quality} Fragmentos de Estrela</p>
                            <button onclick="upgradeTarget('${type}', '${instanceId}', 'quality')" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white py-1 rounded">Melhorar (${playerData.starFragments || 0})</button>
                        </div>
                        ${type === 'character' ? `
                            <div class="bg-black/40 p-3 rounded">
                                <h3 class="font-semibold mb-2">Habilidade (Nv.${target.skillLevel})</h3>
                                <p class="text-sm text-gray-400 mb-2">Custo: ${getSkillUpgradeCost(target.skillLevel)} Tomos de Habilidade</p>
                                <button onclick="upgradeTarget('${type}', '${instanceId}', 'skill')" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-1 rounded">Melhorar (${playerData.items.skill_tome_1 || 0})</button>
                            </div>
                        ` : ''}
                    </div>
                    <button onclick="document.getElementById('upgrade-modal').classList.add('hidden')" class="mt-4 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Fechar</button>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        async function upgradeTarget(type, instanceId, upgradeType) {
            const target = type === 'character' ? playerData.characters[instanceId] : playerData.equipment[instanceId];
            
            switch(upgradeType) {
                case 'level':
                    const itemId = document.getElementById('upgrade-level-item').value;
                    const amount = parseInt(document.getElementById('upgrade-level-amount').value) || 1;
                    if((playerData.items[itemId] || 0) < amount) {
                        await customAlert("Itens insuficientes!"); return;
                    }
                    playerData.items[itemId] -= amount;
                    target.exp += GAME_DB.items[itemId].value * amount;
                    let requiredExp = getRequiredExp(target.level);
                    while(target.exp >= requiredExp) {
                        target.exp -= requiredExp;
                        target.level++;
                        requiredExp = getRequiredExp(target.level);
                    }
                    break;
                case 'refine':
                    const refineCost = getRefineCost(target.refinement);
                    const refineItemId = 'refine_stone_1';
                    if((playerData.items[refineItemId] || 0) < refineCost) {
                        await customAlert("Itens insuficientes!"); return;
                    }
                    playerData.items[refineItemId] -= refineCost;
                    target.refinement++;
                    if(target.refinement % 5 === 0) {
                        const possibleStats = ['atk', 'def', 'hp', 'speed'];
                        const randomStat = possibleStats[Math.floor(Math.random() * possibleStats.length)];
                        const value = (randomStat === 'hp' ? 20 : (randomStat === 'speed' ? 1 : 2)) * (target.refinement / 5);
                        target.refine_bonus_stats[randomStat] = (target.refine_bonus_stats[randomStat] || 0) + value;
                        await customAlert(`Novo b√¥nus de refinamento: ${randomStat.toUpperCase()} +${value}!`);
                    }
                    break;
                case 'quality':
                    if (target.quality >= 25) { 
                        await customAlert("Qualidade m√°xima atingida!"); return;
                    }
                    const qualityCost = target.quality;
                    if(playerData.starFragments < qualityCost) {
                        await customAlert("Fragmentos de Estrela insuficientes!"); return;
                    }
                    playerData.starFragments -= qualityCost;
                    target.quality++;
                    break;
                case 'skill':
                    const skillCost = getSkillUpgradeCost(target.skillLevel);
                    const skillItemId = 'skill_tome_1';
                    if((playerData.items[skillItemId] || 0) < skillCost) {
                        await customAlert("Itens insuficientes!"); return;
                    }
                    playerData.items[skillItemId] -= skillCost;
                    target.skillLevel++;
                    break;
            }
            
            savePlayerData();
            openUpgradeModal(type, instanceId); // Refresh modal
            updateUI();
            checkAchievements();
        }

        // --- UI & RENDERING ---
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screen = document.getElementById(`${screenId}-screen`);
            if(screen) screen.classList.add('active');
            
            document.querySelectorAll('.nav-button, .mobile-nav-button').forEach(b => b.classList.remove('active'));
            
            const activateButtons = (selector) => document.querySelectorAll(selector).forEach(b => b.classList.add('active'));
            activateButtons(`.nav-button[data-screen="${screenId}"]`);
            activateButtons(`.mobile-nav-button[data-screen="${screenId}"]`);
            
            const moreMenuScreens = ['recruit', 'daily-rewards', 'achievements', 'systems', 'ranking', 'admin'];
            if (moreMenuScreens.includes(screenId)) {
                activateButtons('#mobile-more-btn');
            }
            
            switch (screenId) {
                case 'home': renderHomeScreen(); break;
                case 'battle': renderStageSelection(); break;
                case 'characters': renderCharacterCollection(); break;
                case 'formation': renderFormationScreen(); break;
                case 'inventory': renderInventoryScreen(); break;
                case 'recruit': renderRecruitScreen(); break;
                case 'daily-rewards': renderDailyRewardsScreen(); break;
                case 'achievements': renderAchievementsScreen(); break;
                case 'systems': renderSystemsScreen(); break;
                case 'prestige': renderPrestigeScreen(); break;
                case 'mastery': renderMasteryScreen(); break;
                case 'pets': renderPetsScreen(); break;
                case 'artifacts': renderArtifactsScreen(); break;
                case 'events': renderEventsScreen(); break;
                case 'season': renderSeasonScreen(); break;
                case 'ranking': renderRankingScreen(); break;
                case 'admin': renderAdminScreen(); break;
                case 'battle-arena':
                    if (battleState.type) { 
                        const stageName = battleState.type === 'stage' ? GAME_DB.stages[battleState.stageIndex].name : `Desafio Infinito - N√≠vel ${playerData.endlessLevel}`;
                        renderBattleArena({ name: stageName, background: battleState.background });
                    }
                    break;
            }
             
            const moreMenu = document.getElementById('mobile-more-menu');
            if(moreMenu && !moreMenu.classList.contains('hidden')) {
                moreMenu.classList.add('hidden', 'opacity-0', 'translate-y-2');
            }
        }

        function updateUI() {
            document.getElementById('player-currency').innerText = formatNumber(playerData.currency);
            document.getElementById('player-star-fragments').innerText = formatNumber(playerData.starFragments);
            document.getElementById('mobile-player-currency').innerText = formatNumber(playerData.currency);
            document.getElementById('mobile-player-star-fragments').innerText = formatNumber(playerData.starFragments);
            
            const activeScreen = document.querySelector('.screen.active');
            if (activeScreen) {
                const screenId = activeScreen.id.replace('-screen', '');
                // Re-render the current screen to reflect data changes
                const renderFunction = window[`render${screenId.charAt(0).toUpperCase() + screenId.slice(1)}Screen`] || window[`render${screenId.charAt(0).toUpperCase() + screenId.slice(1)}`];
                if (typeof renderFunction === 'function' && screenId !== 'battle-arena') {
                     // Special screens that should not auto-refresh this way
                    if(['battle','home','characters','formation','inventory','recruit','daily-rewards','achievements','systems','prestige','mastery','pets','artifacts','events','season','ranking','admin'].includes(screenId)){
                         switchScreen(screenId);
                    }
                }
            }
        }
        
        function renderHomeScreen() {
            const container = document.getElementById('home-screen');
            let favoriteCharId = playerData.favoriteCharacter;

            if (!favoriteCharId || !playerData.characters[favoriteCharId]) {
                const firstFormationChar = playerData.formation.find(id => id);
                favoriteCharId = firstFormationChar || Object.keys(playerData.characters)[0];
            }

            if (!favoriteCharId) {
                 container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-lg text-gray-400">Voc√™ ainda n√£o tem her√≥is.</p>
                        <p class="text-sm text-gray-500">V√° para a tela de Recrutar para conseguir seu primeiro her√≥i!</p>
                    </div>
                `;
                return;
            }

            const pChar = playerData.characters[favoriteCharId];
            const baseChar = GAME_DB.characters[pChar.id];
            const recommendedBP = 800 + (playerData.endlessLevel - 1) * 400;
            const currentBP = calculateTotalBP();
            container.innerHTML = `
                <div class="flex flex-col items-center justify-center text-center">
                    <img src="${baseChar.image}" alt="${baseChar.name}" class="home-character-display">
                    <div class="bg-black/30 p-4 rounded-lg w-full max-w-md">
                         <h2 class="text-2xl font-bold text-white">Desafio Infinito</h2>
                         <p class="text-yellow-300 font-semibold text-lg mb-2">N√≠vel ${playerData.endlessLevel}</p>
                         <div class="text-sm">
                             <p class="text-gray-400">PB Recomendado: ${formatNumber(recommendedBP)}</p>
                             <p class="font-semibold ${currentBP < recommendedBP ? 'text-red-400' : 'text-green-400'}">Seu PB: ${formatNumber(currentBP)}</p>
                         </div>
                         <button onclick="startEndlessBattle()" class="btn-grad font-bold py-3 px-10 rounded-lg mt-4 text-xl">Lutar</button>
                    </div>
                </div>
            `;
        }

        function renderStageSelection() {
            const container = document.getElementById('battle-screen');
            const currentBP = calculateTotalBP();
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-white">Modo Campanha</h2>
                <div id="stage-selection" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    ${GAME_DB.stages.map((stage, index) => `
                        <div class="bg-black/30 rounded-lg overflow-hidden cursor-pointer hover:border-primary border-2 border-transparent transition-all" onclick="startBattle(${index})">
                            <img src="${stage.background}" alt="${stage.name}" class="w-full h-32 object-cover">
                            <div class="p-4">
                                <h3 class="font-bold text-lg">${stage.name}</h3>
                                <p class="text-sm text-gray-400">PB Recomendado: ${formatNumber(stage.recommendedBP)}</p>
                                <p class="text-sm font-semibold ${currentBP < stage.recommendedBP ? 'text-red-400' : 'text-green-400'}">Seu PB: ${formatNumber(currentBP)}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>`;
        }

        function renderBattleArena(stage) {
            const container = document.getElementById('battle-arena-screen');
            container.innerHTML = `
                <div id="battle-arena" class="relative p-4 md:p-8 min-h-[70vh] flex flex-col justify-between" style="background-image: url('${stage.background}')">
                    <div id="enemy-team" class="flex justify-center gap-4">
                        ${battleState.enemyTeam.map(enemy => `
                            <div class="battle-character text-center enemy" data-combatant-id="${enemy.instanceId}">
                                <img src="${enemy.stats.image}" class="h-24 md:h-32 pointer-events-none">
                                <p class="text-sm font-bold text-white bg-black/50 rounded px-1">${enemy.stats.name}</p>
                                <div class="health-bar-bg mt-1"><div id="hp-${enemy.instanceId}" class="health-bar-fill enemy h-2" style="width: 100%"></div></div>
                            </div>
                        `).join('')}
                    </div>
                    <div id="player-team" class="flex justify-center gap-4">
                        ${battleState.playerTeam.map(player => `
                            <div class="battle-character text-center player" data-combatant-id="${player.instanceId}">
                                <img src="${GAME_DB.characters[playerData.characters[player.instanceId].id].image}" class="h-24 md:h-32 pointer-events-none transform -scale-x-100">
                                <p class="text-sm font-bold text-white bg-black/50 rounded px-1">${GAME_DB.characters[playerData.characters[player.instanceId].id].name}</p>
                                <div class="health-bar-bg mt-1"><div id="hp-${player.instanceId}" class="health-bar-fill h-2" style="width: 100%"></div></div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="absolute top-2 right-2 bg-black/50 rounded-lg p-2 flex gap-2">
                        <button id="give-up-btn" class="text-white bg-red-600 hover:bg-red-700 font-bold px-3 py-1 rounded-md">Desistir</button>
                        <button id="battle-speed-btn" class="text-white font-bold">Velocidade: ${currentBattleSpeed}x</button>
                    </div>
                </div>`;
            document.getElementById('battle-speed-btn').onclick = () => {
                currentBattleSpeed = currentBattleSpeed === 1 ? 2 : 1;
                battleState.battleSpeed = currentBattleSpeed;
                document.getElementById('battle-speed-btn').innerText = `Velocidade: ${currentBattleSpeed}x`;
            };
            document.getElementById('give-up-btn').onclick = async () => {
                if (await customConfirm("Tem certeza que deseja desistir da batalha?")) {
                    battleState.isBattleOver = true;
                    if (battleLoopId) clearTimeout(battleLoopId);
                    showBattleResult(false);
                }
            };
        }
        
        function updateHealthBar(combatant) {
            const healthBarElement = document.getElementById(`hp-${combatant.instanceId}`);
            if (healthBarElement) {
                const maxHp = getCombatantStats(combatant).hp;
                const percentage = (combatant.currentHp / maxHp) * 100;
                healthBarElement.style.width = `${percentage}%`;
            }
        }

        function showDamageNumber(target, damage, type) {
            const targetEl = document.querySelector(`[data-combatant-id="${target.instanceId}"]`);
            if(targetEl) {
                const damageEl = document.createElement('div');
                damageEl.className = `damage-text ${type}`;
                damageEl.innerText = formatNumber(damage);
                targetEl.appendChild(damageEl);
                setTimeout(() => damageEl.remove(), 1000);
            }
        }
        
         function showSkillName(combatant, skillName) {
            const combatantEl = document.querySelector(`[data-combatant-id="${combatant.instanceId}"]`);
            if (combatantEl) {
                const skillEl = document.createElement('div');
                skillEl.className = 'damage-text skill';
                skillEl.innerText = skillName;
                combatantEl.appendChild(skillEl);
                setTimeout(() => skillEl.remove(), 1000);
            }
        }

        function showBattleResult(isVictory) {
            let rewardText = '';
            let buttonsHTML = '';
            if (isVictory) {
                if (battleState.type === 'stage') {
                    const stage = GAME_DB.stages[battleState.stageIndex];
                    playerData.currency += stage.reward;
                    rewardText = `<p class="text-lg text-yellow-300 mt-2">Recompensa: ${formatNumber(stage.reward)} Cristais</p>`;
                    const nextStageExists = battleState.stageIndex + 1 < GAME_DB.stages.length;
                    buttonsHTML = `
                        <button onclick="document.getElementById('battle-result-modal').classList.add('hidden'); switchScreen('battle');" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded">Parar</button>
                        ${nextStageExists ? `<button onclick="document.getElementById('battle-result-modal').classList.add('hidden'); startBattle(${battleState.stageIndex + 1});" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">Pr√≥xima Fase</button>` : ''}
                    `;
                } else if (battleState.type === 'endless') {
                    setTimeout(continueEndlessBattle, 1500); 
                    return;
                }
                savePlayerData();
            } else {
                 buttonsHTML = `<button onclick="document.getElementById('battle-result-modal').classList.add('hidden'); switchScreen('battle');" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded">OK</button>`;
            }

            const modal = document.getElementById('battle-result-modal');
            modal.innerHTML = `
                <div class="bg-gray-800 p-6 rounded-lg text-center max-w-md w-full">
                    <h2 class="text-2xl font-bold mb-4 ${isVictory ? 'text-green-400' : 'text-red-400'}">${isVictory ? 'üéâ Vit√≥ria!' : 'üíÄ Derrota!'}</h2>
                    <p class="text-lg">${isVictory ? 'Parab√©ns! Voc√™ venceu a batalha!' : 'Voc√™ foi derrotado. Tente novamente!'}</p>
                    ${rewardText}
                    <div class="flex gap-2 justify-center mt-6">${buttonsHTML}</div>
                </div>
            `;
            modal.classList.remove('hidden');
            updateUI();
        }

        function renderCharacterCollection() {
            const container = document.getElementById('characters-screen');
            const charEntries = Object.entries(playerData.characters);
            
            if (charEntries.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-8">
                        <p class="text-lg text-gray-400">Voc√™ ainda n√£o tem her√≥is.</p>
                        <p class="text-sm text-gray-500">V√° para a tela de Recrutar para conseguir seu primeiro her√≥i!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-white">Meus Her√≥is (${charEntries.length})</h2>
                    <button onclick="switchScreen('formation')" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded">
                        Forma√ß√£o
                    </button>
                </div>
                <div id="formation-character-list" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    ${charEntries.map(([instanceId]) => createCharacterCard(instanceId, true)).join('')}
                </div>
            `;
        }

        function renderFormationScreen() {
            const container = document.getElementById('formation-screen');
            const totalBP = calculateTotalBP();
            
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-white">Forma√ß√£o de Batalha</h2>
                <div class="bg-black/30 p-4 rounded-lg mb-6">
                    <p class="text-center text-lg font-bold text-yellow-300">Poder de Batalha Total: ${formatNumber(totalBP)}</p>
                </div>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    ${playerData.formation.map((charId, index) => `
                        <div class="formation-slot bg-gray-700 border-2 border-dashed border-gray-500 rounded-lg p-4 text-center min-h-[120px] flex flex-col justify-center">
                            ${charId ? `
                                <img src="${GAME_DB.characters[playerData.characters[charId].id].image}" class="w-16 h-20 mx-auto object-cover rounded border-2 rarity-${GAME_DB.characters[playerData.characters[charId].id].rarity}">
                                <p class="text-xs mt-2 font-semibold truncate">${GAME_DB.characters[playerData.characters[charId].id].name}</p>
                                <p class="text-xs text-yellow-300">BP ${formatNumber(calculateBP(charId))}</p>
                                <button onclick="openFormationPlacementModal('${charId}')" class="mt-1 text-xs bg-red-600 hover:bg-red-700 text-white px-2 py-1 rounded">Remover</button>
                            ` : `
                                <div class="w-16 h-20 mx-auto bg-gray-600 rounded flex items-center justify-center">
                                    <span class="text-2xl text-gray-400">+</span>
                                </div>
                                <p class="text-xs mt-2 text-gray-400">Slot ${index + 1}</p>
                            `}
                        </div>
                    `).join('')}
                </div>
                <button onclick="switchScreen('characters')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                    Gerenciar Her√≥is
                </button>
            `;
        }

        function renderInventoryScreen() {
            const container = document.getElementById('inventory-screen');
            const itemEntries = Object.entries(playerData.items).filter(([id, count]) => count > 0);
            
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-white">Invent√°rio</h2>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-black/30 p-4 rounded-lg text-center">
                        <img src="https://placehold.co/48x48/e0af68/1a1b26?text=$" class="mx-auto mb-2" alt="Cristais">
                        <p class="font-bold text-yellow-400">${formatNumber(playerData.currency)}</p>
                        <p class="text-sm text-gray-400">Cristais</p>
                    </div>
                    <div class="bg-black/30 p-4 rounded-lg text-center">
                        <img src="https://placehold.co/48x48/ffd700/1a1b26?text=‚òÖ" class="mx-auto mb-2" alt="Fragmentos de Estrela">
                        <p class="font-bold text-yellow-300">${formatNumber(playerData.starFragments)}</p>
                        <p class="text-sm text-gray-400">Fragmentos de Estrela</p>
                    </div>
                </div>
                ${itemEntries.length > 0 ? `
                    <h3 class="text-lg font-bold mb-4 text-white">Itens</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        ${itemEntries.map(([itemId, count]) => {
                            const item = GAME_DB.items[itemId];
                            return item ? `
                                <div class="bg-black/30 p-3 rounded-lg text-center">
                                    <img src="${item.image}" alt="${item.name}" class="w-12 h-12 mx-auto mb-2">
                                    <p class="text-sm font-semibold truncate">${item.name}</p>
                                    <p class="text-lg font-bold text-yellow-400">${count}</p>
                                </div>
                            ` : "";
                        }).join('')}
                    </div>
                ` : `
                    <div class="text-center py-8"><p class="text-lg text-gray-400">Seu invent√°rio de itens est√° vazio.</p></div>
                `}
                <div class="mt-6">
                    <h3 class="text-lg font-bold mb-4 text-white">Equipamentos</h3>
                    ${Object.keys(playerData.equipment).length > 0 ? `
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                            ${Object.entries(playerData.equipment).map(([eqInstanceId, pEq]) => {
                                const baseEq = GAME_DB.equipment[pEq.id];
                                return `
                                    <div onclick="openEquipmentDetailModal('${eqInstanceId}')" class="bg-black/30 p-3 rounded-lg text-center cursor-pointer hover:bg-black/50 border-2 rarity-${baseEq.rarity}">
                                        <img src="${baseEq.image}" alt="${baseEq.name}" class="w-12 h-12 mx-auto mb-2">
                                        <p class="text-sm font-semibold truncate">${baseEq.name}</p>
                                        <p class="text-xs text-gray-400">Nv.${pEq.level}</p>
                                        <p class="text-xs ${pEq.equippedTo ? 'text-green-400' : 'text-gray-400'}">
                                            ${pEq.equippedTo ? 'Equipado' : 'Dispon√≠vel'}
                                        </p>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    ` : `
                        <div class="text-center py-4"><p class="text-gray-400">Nenhum equipamento encontrado.</p></div>
                    `}
                </div>
            `;
        }

        function renderRecruitScreen() {
            const container = document.getElementById('recruit-screen');
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-6 text-white text-center">Central de Recrutamento</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-gradient-to-br from-purple-900/50 to-blue-900/50 p-6 rounded-lg border-2 border-purple-500">
                        <h3 class="text-xl font-bold mb-4 text-center text-purple-300">Invocar Her√≥is</h3>
                        <img src="https://placehold.co/120x160/bb9af7/1a1b26?text=Hero" class="mx-auto rounded-lg border-2 border-purple-400 mb-4" alt="Invoca√ß√£o de Her√≥i">
                        <div class="text-sm text-gray-300 mb-4"><p>‚Ä¢ 5‚òÖ: 3%</p><p>‚Ä¢ 4‚òÖ: 12%</p><p>‚Ä¢ 3‚òÖ: 25%</p><p>‚Ä¢ 2‚òÖ: 35%</p><p>‚Ä¢ 1‚òÖ: 25%</p></div>
                        <div class="space-y-3">
                            <button onclick="recruit('hero', 1)" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-4 rounded-lg">1x - 150 üíé</button>
                            <button onclick="recruit('hero', 10)" class="w-full bg-purple-700 hover:bg-purple-800 text-white font-bold py-3 px-4 rounded-lg">10x - 1,500 üíé</button>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-orange-900/50 to-red-900/50 p-6 rounded-lg border-2 border-orange-500">
                        <h3 class="text-xl font-bold mb-4 text-center text-orange-300">Invocar Equipamentos</h3>
                        <img src="https://placehold.co/120x120/e0af68/1a1b26?text=Equip" class="mx-auto rounded-lg border-2 border-orange-400 mb-4" alt="Invoca√ß√£o de Equipamento">
                        <div class="text-sm text-gray-300 mb-4"><p>‚Ä¢ 5‚òÖ: 3%</p><p>‚Ä¢ 4‚òÖ: 12%</p><p>‚Ä¢ 3‚òÖ: 25%</p><p>‚Ä¢ 2‚òÖ: 35%</p><p>‚Ä¢ 1‚òÖ: 25%</p></div>
                        <div class="space-y-3">
                            <button onclick="recruit('equipment', 1)" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-4 rounded-lg">1x - 100 üíé</button>
                            <button onclick="recruit('equipment', 10)" class="w-full bg-orange-700 hover:bg-orange-800 text-white font-bold py-3 px-4 rounded-lg">10x - 1,000 üíé</button>
                        </div>
                    </div>
                     <div class="bg-gradient-to-br from-green-900/50 to-teal-900/50 p-6 rounded-lg border-2 border-green-500">
                        <h3 class="text-xl font-bold mb-4 text-center text-green-300">Invocar Pets</h3>
                        <img src="https://placehold.co/120x120/73daca/1a1b26?text=Pet" class="mx-auto rounded-full border-2 border-green-400 mb-4" alt="Invoca√ß√£o de Pet">
                        <div class="text-sm text-gray-300 mb-4"><p>‚Ä¢ 5‚òÖ: 5%</p><p>‚Ä¢ 4‚òÖ: 15%</p><p>‚Ä¢ 3‚òÖ: 30%</p><p>‚Ä¢ 2‚òÖ: 50%</p></div>
                        <div class="space-y-3">
                            <button onclick="recruit('pet', 1)" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">1x - 120 üíé</button>
                            <button onclick="recruit('pet', 10)" class="w-full bg-green-700 hover:bg-green-800 text-white font-bold py-3 px-4 rounded-lg">10x - 1,200 üíé</button>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-indigo-900/50 to-sky-900/50 p-6 rounded-lg border-2 border-sky-500">
                        <h3 class="text-xl font-bold mb-4 text-center text-sky-300">Invocar Artefatos</h3>
                        <img src="https://placehold.co/120x120/7dcfff/1a1b26?text=Artifact" class="mx-auto rounded-full border-2 border-sky-400 mb-4" alt="Invoca√ß√£o de Artefato">
                        <div class="text-sm text-gray-300 mb-4"><p>‚Ä¢ 5‚òÖ: 5%</p><p>‚Ä¢ 4‚òÖ: 15%</p><p>‚Ä¢ 3‚òÖ: 30%</p><p>‚Ä¢ 2‚òÖ: 50%</p></div>
                        <div class="space-y-3">
                            <button onclick="recruit('artifact', 1)" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg">1x - 250 üíé</button>
                            <button onclick="recruit('artifact', 10)" class="w-full bg-sky-700 hover:bg-sky-800 text-white font-bold py-3 px-4 rounded-lg">10x - 2,500 üíé</button>
                        </div>
                    </div>
                </div>
                <div class="mt-6 bg-black/30 p-4 rounded-lg">
                    <h3 class="text-lg font-bold mb-2 text-yellow-300">üí° Dica</h3>
                    <p class="text-sm text-gray-300">Her√≥is, Pets e Artefatos duplicados s√£o convertidos em <span class="font-bold">Fragmentos</span> para melhorar suas unidades!</p>
                </div>
            `;
        }

        // --- NEW SYSTEMS RENDERING ---
        function renderDailyRewardsScreen() {
            const container = document.getElementById('daily-rewards-screen');
            checkDailyRewards();
            
            const today = new Date().toDateString();
            const hasClaimedToday = playerData.dailyRewards.lastClaim === today;
            const currentStreak = playerData.dailyRewards.streak;
            
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-6 text-white text-center">Recompensas Di√°rias</h2>
                <div class="bg-black/30 p-4 rounded-lg mb-6 text-center">
                    <h3 class="text-lg font-bold text-yellow-300 mb-2">Sequ√™ncia Atual: ${currentStreak} dias</h3>
                    <p class="text-sm text-gray-400">${hasClaimedToday ? 'Voc√™ j√° coletou a recompensa de hoje!' : `Colete a recompensa do dia ${currentStreak}!`}</p>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-7 gap-4">
                    ${GAME_DB.dailyRewards.map((reward, index) => {
                        const day = index + 1;
                        const isClaimed = hasClaimedToday && day <= currentStreak;
                        const isAvailable = !hasClaimedToday && day === currentStreak;
                        const isLocked = day > currentStreak;
                        
                        let rewardText = '';
                        if (reward.reward.currency) rewardText = `${reward.reward.currency} üíé`;
                        else if (reward.reward.starFragments) rewardText = `${reward.reward.starFragments} ‚≠ê`;
                        else if (reward.reward.items) rewardText = `${Object.values(reward.reward.items).reduce((a, b) => a + b, 0)} Itens`;
                        
                        return `
                            <div class="daily-reward-item bg-black/30 p-4 rounded-lg text-center border-2 ${isClaimed ? 'border-green-500 claimed' : isAvailable ? 'border-yellow-500 available' : 'border-gray-600'}" ${isAvailable ? `onclick="claimDailyReward(${day})"` : ''}>
                                <div class="text-2xl mb-2">${day === 7 ? 'üéÅ' : (isClaimed || (day < currentStreak && !isAvailable)) ? '‚úÖ' : 'üìÖ'}</div>
                                <img src="${reward.image}" alt="Recompensa do Dia ${day}" class="w-12 h-12 mx-auto mb-2">
                                <p class="text-xs font-bold">Dia ${day}</p>
                                <p class="text-xs text-yellow-300">${rewardText}</p>
                                ${isClaimed ? '<p class="text-xs text-green-400 mt-1">Coletado</p>' : isAvailable ? '<p class="text-xs text-yellow-400 mt-1">Dispon√≠vel</p>' : isLocked ? '<p class="text-xs text-gray-500 mt-1">Bloqueado</p>' : '<p class="text-xs text-gray-400 mt-1">Pendente</p>'}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        function renderAchievementsScreen() {
            const container = document.getElementById('achievements-screen');
            const achievements = GAME_DB.achievements;
            const completedCount = Object.values(playerData.achievements).filter(Boolean).length;
            const totalCount = Object.keys(achievements).length;
            
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-6 text-white text-center">Conquistas</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${Object.entries(achievements).map(([id, achievement]) => {
                        const isCompleted = playerData.achievements[id];
                        let rewardText = '';
                        if (achievement.reward.currency) rewardText += `${achievement.reward.currency} üíé `;
                        if (achievement.reward.starFragments) rewardText += `${achievement.reward.starFragments} ‚≠ê`;
                        
                        return `
                            <div class="bg-black/30 p-4 rounded-lg border-2 ${isCompleted ? 'border-green-500' : 'border-gray-600'} flex items-center gap-3">
                                <div class="text-3xl">${isCompleted ? 'üèÜ' : 'üîí'}</div>
                                <div class="flex-1">
                                    <h3 class="font-bold text-lg ${isCompleted ? 'text-green-400' : 'text-white'}">${achievement.name}</h3>
                                    <p class="text-sm text-gray-400 mb-2">${achievement.description}</p>
                                    <p class="text-sm font-bold text-yellow-300">Recompensa: ${rewardText}</p>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-6 bg-black/30 p-4 rounded-lg text-center">
                    <h3 class="text-lg font-bold mb-2 text-purple-300">Progresso Geral: ${completedCount} / ${totalCount}</h3>
                    <div class="progress-bar-bg h-3 mt-2"><div class="progress-bar-fill h-full" style="width: ${(completedCount / totalCount) * 100}%"></div></div>
                </div>
            `;
        }

        function renderRankingScreen() { renderPlaceholderScreen('ranking', 'Ranking', 'üèÜ'); }

        function renderPlaceholderScreen(screenId, title, icon) {
            const container = document.getElementById(`${screenId}-screen`);
            container.innerHTML = `
                <div class="text-center py-16">
                    <div class="text-6xl mb-4">${icon}</div>
                    <h2 class="text-2xl font-bold mb-4">${title}</h2>
                    <p class="text-gray-400">Em breve...</p>
                </div>
            `;
        }

        function renderAdminScreen() {
            const container = document.getElementById('admin-screen');
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-4 text-red-400">Painel de Administrador</h2>
                <div class="space-y-6">
                    <!-- RECURSOS -->
                    <div class="bg-black/20 p-4 rounded-lg space-y-2">
                        <h3 class="font-semibold mb-2">Adicionar Recursos</h3>
                        <div class="flex items-center gap-2">
                            <input id="admin-currency-amount" type="number" value="5000" class="bg-gray-700 p-2 rounded w-full">
                            <button id="admin-add-currency" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">Add Cristais</button>
                        </div>
                        <div class="flex items-center gap-2">
                            <input id="admin-star-fragments-amount" type="number" value="100" class="bg-gray-700 p-2 rounded w-full">
                            <button id="admin-add-star-fragments" class="bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">Add Fragmentos (Her√≥i)</button>
                        </div>
                        ${Object.keys(GAME_DB.items).map(itemId => {
                            const item = GAME_DB.items[itemId];
                            return `<div class="flex items-center gap-2">
                                <input id="admin-item-${itemId}" type="number" value="10" class="bg-gray-700 p-2 rounded w-full">
                                <button data-item-id="${itemId}" class="admin-add-item-btn bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">Add ${item.name}</button>
                            </div>`
                        }).join('')}
                         ${Object.keys(GAME_DB.pets).map(petId => {
                            const pet = GAME_DB.pets[petId];
                            return `<div class="flex items-center gap-2">
                                <input id="admin-pet-fragment-${petId}" type="number" value="10" class="bg-gray-700 p-2 rounded w-full">
                                <button data-pet-id="${petId}" class="admin-add-pet-fragment-btn bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">Add Fragmento (${pet.name})</button>
                            </div>`
                        }).join('')}
                    </div>
                    
                    <!-- EDITOR DE HER√ìI -->
                    <div class="bg-black/20 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">Editor de Her√≥i</h3>
                        <select id="admin-char-editor-select" class="bg-gray-700 text-white p-2 rounded w-full mb-2">
                            <option value="">Selecione um her√≥i para editar...</option>
                        </select>
                        <div id="admin-char-editor-fields" class="hidden grid grid-cols-2 gap-x-4 gap-y-2"></div>
                    </div>
                    
                    <!-- EDITOR DE EQUIPAMENTO -->
                    <div class="bg-black/20 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">Editor de Equipamento</h3>
                        <select id="admin-equip-editor-select" class="bg-gray-700 text-white p-2 rounded w-full mb-2">
                            <option value="">Selecione um equipamento para editar...</option>
                        </select>
                        <div id="admin-equip-editor-fields" class="hidden grid grid-cols-2 gap-x-4 gap-y-2"></div>
                    </div>

                    <!-- EDITOR DE ARTEFATO -->
                    <div class="bg-black/20 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2">Adicionar Fragmentos de Artefato</h3>
                        <div class="flex items-center gap-2">
                            <select id="admin-artifact-fragment-select" class="bg-gray-700 p-2 rounded w-full">
                                ${Object.keys(GAME_DB.artifacts).map(artId => `<option value="${artId}">${GAME_DB.artifacts[artId].name}</option>`).join('')}
                            </select>
                            <input id="admin-artifact-fragment-amount" type="number" value="100" class="bg-gray-700 p-2 rounded w-48">
                            <button id="admin-add-artifact-fragments" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded whitespace-nowrap">Add Fragmentos</button>
                        </div>
                    </div>

                    <!-- A√á√ïES PERIGOSAS -->
                    <div class="bg-black/20 p-4 rounded-lg">
                        <h3 class="font-semibold mb-2 text-yellow-400">A√ß√µes Perigosas</h3>
                        <button id="admin-reset-account" class="bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-4 rounded">Resetar Conta</button>
                    </div>
                </div>`;
                
            // --- Setup Listeners (CORRIGIDO) ---

            // Resources
            document.getElementById('admin-add-currency').onclick = () => {
                const amount = parseInt(document.getElementById('admin-currency-amount').value, 10) || 0;
                playerData.currency += amount; 
                savePlayerData(); 
                updateUI();
            };
            document.getElementById('admin-add-star-fragments').onclick = () => {
                const amount = parseInt(document.getElementById('admin-star-fragments-amount').value, 10) || 0;
                playerData.starFragments += amount; 
                savePlayerData(); 
                updateUI();
            };
            document.querySelectorAll('.admin-add-item-btn').forEach(btn => {
                btn.onclick = async () => {
                    const itemId = btn.dataset.itemId;
                    const amount = parseInt(document.getElementById(`admin-item-${itemId}`).value, 10) || 0;
                    playerData.items[itemId] = (playerData.items[itemId] || 0) + amount;
                    savePlayerData();
                    updateUI();
                    await customAlert(`${amount} de ${GAME_DB.items[itemId].name} adicionado(s)!`);
                };
            });
             document.querySelectorAll('.admin-add-pet-fragment-btn').forEach(btn => {
                btn.onclick = async () => {
                    const petId = btn.dataset.petId;
                    const amount = parseInt(document.getElementById(`admin-pet-fragment-${petId}`).value, 10) || 0;
                    playerData.petFragments[petId] = (playerData.petFragments[petId] || 0) + amount;
                    savePlayerData();
                    updateUI();
                    await customAlert(`${amount} fragmentos de ${GAME_DB.pets[petId].name} adicionado(s)!`);
                };
            });
            document.getElementById('admin-add-artifact-fragments').onclick = async () => {
                const artifactId = document.getElementById('admin-artifact-fragment-select').value;
                const amount = parseInt(document.getElementById('admin-artifact-fragment-amount').value, 10) || 0;
                playerData.artifacts.fragments[artifactId] = (playerData.artifacts.fragments[artifactId] || 0) + amount;
                savePlayerData();
                updateUI();
                await customAlert(`${amount} fragmentos de ${GAME_DB.artifacts[artifactId].name} adicionados!`);
            };
            document.getElementById('admin-reset-account').onclick = async () => { 
                if (await customConfirm("TEM CERTEZA? Resetar a conta ir√° apagar todo o progresso.")) { 
                    localStorage.removeItem(`ala_playerData_${currentUser}`); 
                    window.location.reload(); 
                }
            };
            
            // Character Editor
            const charEditorSelect = document.getElementById('admin-char-editor-select');
            charEditorSelect.innerHTML = '<option value="">Selecione um her√≥i para editar...</option>'; // Clear before populating
            Object.entries(playerData.characters).forEach(([instanceId, pChar]) => {
                charEditorSelect.innerHTML += `<option value="${instanceId}">${GAME_DB.characters[pChar.id].name} (Nv.${pChar.level})</option>`;
            });
            charEditorSelect.onchange = (e) => {
                const selectedId = e.target.value;
                const fieldsContainer = document.getElementById('admin-char-editor-fields');
                if (!selectedId) {
                    fieldsContainer.innerHTML = '';
                    fieldsContainer.classList.add('hidden');
                    return;
                }
                const pChar = playerData.characters[selectedId];
                const editableStats = { level: pChar.level, exp: pChar.exp, quality: pChar.quality, refinement: pChar.refinement, skillLevel: pChar.skillLevel };

                fieldsContainer.innerHTML = `
                    ${Object.entries(editableStats).map(([stat, value]) => `
                        <label class="capitalize text-sm self-center">${stat}:</label>
                        <input type="number" data-stat="${stat}" value="${value}" class="bg-gray-800 p-1 rounded w-full">
                    `).join('')}
                    <button id="save-char-stats" class="col-span-2 mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Salvar Her√≥i</button>
                `;
                fieldsContainer.classList.remove('hidden');

                document.getElementById('save-char-stats').onclick = async () => {
                    const charToUpdate = playerData.characters[selectedId];
                    fieldsContainer.querySelectorAll('input').forEach(input => {
                        charToUpdate[input.dataset.stat] = parseInt(input.value, 10);
                    });
                    savePlayerData();
                    await customAlert('Her√≥i atualizado!');
                    renderAdminScreen(); // Re-render to update select text if level changed
                    updateUI();
                };
            };
            
            // Equipment Editor
            const equipEditorSelect = document.getElementById('admin-equip-editor-select');
            equipEditorSelect.innerHTML = '<option value="">Selecione um equipamento para editar...</option>'; // Clear before populating
            Object.entries(playerData.equipment).forEach(([instanceId, pEq]) => {
                equipEditorSelect.innerHTML += `<option value="${instanceId}">${GAME_DB.equipment[pEq.id].name} (Nv.${pEq.level})</option>`;
            });
            equipEditorSelect.onchange = (e) => {
                const selectedId = e.target.value;
                const fieldsContainer = document.getElementById('admin-equip-editor-fields');
                if (!selectedId) {
                    fieldsContainer.innerHTML = '';
                    fieldsContainer.classList.add('hidden');
                    return;
                }
                const pEq = playerData.equipment[selectedId];
                const editableStats = { level: pEq.level, exp: pEq.exp, quality: pEq.quality, refinement: pEq.refinement };

                fieldsContainer.innerHTML = `
                    ${Object.entries(editableStats).map(([stat, value]) => `
                        <label class="capitalize text-sm self-center">${stat}:</label>
                        <input type="number" data-stat="${stat}" value="${value}" class="bg-gray-800 p-1 rounded w-full">
                    `).join('')}
                    <button id="save-equip-stats" class="col-span-2 mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Salvar Equipamento</button>
                `;
                fieldsContainer.classList.remove('hidden');

                document.getElementById('save-equip-stats').onclick = async () => {
                    const eqToUpdate = playerData.equipment[selectedId];
                    fieldsContainer.querySelectorAll('input').forEach(input => {
                        eqToUpdate[input.dataset.stat] = parseInt(input.value, 10);
                    });
                    savePlayerData();
                    await customAlert('Equipamento atualizado!');
                    renderAdminScreen(); // Re-render to update select text if level changed
                    updateUI();
                };
            };
        }

        // --- ADVANCED SYSTEMS INITIALIZATION AND RENDERING ---
        
        // Data Structures
        const PET_DATABASE = GAME_DB.pets;

        // Initialization
        function initializeAllSystems() {
            const systems = ['prestige', 'guild', 'events', 'mastery', 'artifacts', 'hardcore', 'season', 'analytics'];
            const defaultValues = {
                prestige: { level: 0, points: 0, bonuses: {} },
                mastery: { battle: { level: 1, exp: 0 } },
                season: { current: 1, level: 1, exp: 0 },
            };
            systems.forEach(sys => {
                if (!playerData[sys]) playerData[sys] = defaultValues[sys] || {};
            });
        }

        // Logic
        function canPrestige() { return playerData.endlessLevel >= 100 && calculateTotalBP() >= 1000000; }
        async function performPrestige() { /* Logic here */ }
        function toggleHardcoreMode() { /* Logic here */ }
        function toggleSpectatorMode() { /* Logic here */ }
        
        function activatePet(instanceId) {
            playerData.pets.active = instanceId;
            savePlayerData();
            updateUI();
            document.getElementById('pet-detail-modal').classList.add('hidden');
            customAlert('Pet ativado com sucesso!');
        }
        
        async function evolvePet(instanceId) {
            const pPet = playerData.pets.collection[instanceId];
            if (!pPet) return;
            const basePet = GAME_DB.pets[pPet.id];

            const fragmentsNeeded = pPet.stars * 10;
            const currentFragments = playerData.petFragments[pPet.id] || 0;

            if (currentFragments >= fragmentsNeeded) {
                playerData.petFragments[pPet.id] -= fragmentsNeeded;
                pPet.stars++;
                savePlayerData();
                await customAlert(`${basePet.name} evoluiu para ${pPet.stars}‚òÖ!`);
                openPetDetailModal(instanceId); // Refresh the modal
                updateUI();
            } else {
                await customAlert("Fragmentos de pet insuficientes para evoluir!");
            }
        }

        function getEvolveArtifactCost(level) {
            return Math.floor(20 * Math.pow(1.8, level - 1));
        }

        async function evolveArtifact(instanceId) {
            const pArt = playerData.artifacts.collection[instanceId];
            if(!pArt) return;
            
            const cost = getEvolveArtifactCost(pArt.level);
            const currentFragments = playerData.artifacts.fragments[pArt.id] || 0;
            
            if (currentFragments >= cost) {
                playerData.artifacts.fragments[pArt.id] -= cost;
                pArt.level++;
                savePlayerData();
                await customAlert(`${GAME_DB.artifacts[pArt.id].name} evoluiu para o N√≠vel ${pArt.level}!`);
                openArtifactDetailModal(instanceId);
                updateUI();
            } else {
                await customAlert("Fragmentos insuficientes!");
            }
        }
        
        function toggleArtifact(instanceId) {
            const equippedIndex = playerData.artifacts.equipped.indexOf(instanceId);
            const maxEquipped = 3;

            if (equippedIndex > -1) {
                playerData.artifacts.equipped.splice(equippedIndex, 1);
            } else {
                if (playerData.artifacts.equipped.length < maxEquipped) {
                    playerData.artifacts.equipped.push(instanceId);
                } else {
                    customAlert(`Voc√™ s√≥ pode equipar ${maxEquipped} artefatos.`);
                    return;
                }
            }
            savePlayerData();
            renderArtifactsScreen(); // Re-render to show changes
            updateUI();
        }
        
        // Rendering
        function renderSystemsScreen() {
            const container = document.getElementById('systems-screen');
            container.innerHTML = `
                <h2 class="text-xl font-bold mb-6 text-white text-center">Sistemas Avan√ßados</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div class="bg-gradient-to-br from-purple-900/50 to-pink-900/50 p-6 rounded-lg border-2 border-purple-500 cursor-pointer hover:scale-105" onclick="switchScreen('prestige')">
                        <div class="text-center"><div class="text-4xl mb-3">üåü</div><h3 class="text-lg font-bold text-purple-300">Prest√≠gio</h3><p class="text-sm text-gray-300">Renas√ßa para b√¥nus permanentes</p>${canPrestige() ? '<p class="text-green-400 font-bold text-xs mt-2">‚úÖ Dispon√≠vel!</p>' : '<p class="text-red-400 text-xs mt-2">‚ùå Indispon√≠vel</p>'}</div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-900/50 to-cyan-900/50 p-6 rounded-lg border-2 border-blue-500 cursor-pointer hover:scale-105" onclick="switchScreen('mastery')">
                         <div class="text-center"><div class="text-4xl mb-3">üìà</div><h3 class="text-lg font-bold text-blue-300">Maestria</h3><p class="text-sm text-gray-300">Melhore habilidades em √°reas</p></div>
                    </div>
                    <div class="bg-gradient-to-br from-green-900/50 to-emerald-900/50 p-6 rounded-lg border-2 border-green-500 cursor-pointer hover:scale-105" onclick="switchScreen('pets')">
                         <div class="text-center"><div class="text-4xl mb-3">üêâ</div><h3 class="text-lg font-bold text-green-300">Pets</h3><p class="text-sm text-gray-300">Companheiros com b√¥nus</p></div>
                    </div>
                     <div class="bg-gradient-to-br from-yellow-900/50 to-orange-900/50 p-6 rounded-lg border-2 border-yellow-500 cursor-pointer hover:scale-105" onclick="switchScreen('artifacts')">
                         <div class="text-center"><div class="text-4xl mb-3">‚ú®</div><h3 class="text-lg font-bold text-yellow-300">Artefatos</h3><p class="text-sm text-gray-300">Itens lend√°rios √∫nicos</p></div>
                    </div>
                     <div class="bg-gradient-to-br from-red-900/50 to-pink-900/50 p-6 rounded-lg border-2 border-red-500 cursor-pointer hover:scale-105" onclick="switchScreen('events')">
                         <div class="text-center"><div class="text-4xl mb-3">üéâ</div><h3 class="text-lg font-bold text-red-300">Eventos</h3><p class="text-sm text-gray-300">Eventos com recompensas</p></div>
                    </div>
                     <div class="bg-gradient-to-br from-indigo-900/50 to-purple-900/50 p-6 rounded-lg border-2 border-indigo-500 cursor-pointer hover:scale-105" onclick="switchScreen('season')">
                         <div class="text-center"><div class="text-4xl mb-3">üèÜ</div><h3 class="text-lg font-bold text-indigo-300">Temporada</h3><p class="text-sm text-gray-300">Progress√£o sazonal</p></div>
                    </div>
                </div>
            `;
        }
        function renderPrestigeScreen() { renderPlaceholderScreen('prestige', 'Prest√≠gio', 'üåü'); }
        function renderMasteryScreen() { renderPlaceholderScreen('mastery', 'Maestria', 'üìà'); }
        
        function openPetDetailModal(instanceId) {
            const modal = document.getElementById('pet-detail-modal');
            const pPet = playerData.pets.collection[instanceId];
            if (!pPet) return;
            const basePet = GAME_DB.pets[pPet.id];
            const isActive = playerData.pets.active === instanceId;
            
            const fragmentsNeeded = pPet.stars * 10;
            const currentFragments = playerData.petFragments[pPet.id] || 0;
            const haveEnoughFragments = currentFragments >= fragmentsNeeded;
            
            const currentBonus = getPetBonus(pPet);
            const nextBonus = getPetBonus({ ...pPet, stars: pPet.stars + 1 });

            let currentBonusText = Object.entries(currentBonus).map(([stat, value]) => `${stat.replace('_percent','').toUpperCase()} +${(value*100).toFixed(2)}%`).join(', ');
            let nextBonusText = Object.entries(nextBonus).map(([stat, value]) => `${stat.replace('_percent','').toUpperCase()} +${(value*100).toFixed(2)}%`).join(', ');

            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto relative border-2 border-green-500">
                    <button onclick="document.getElementById('pet-detail-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-red-600 rounded-full h-8 w-8 font-bold z-10">X</button>
                    <div class="text-center">
                        <img src="${basePet.image}" alt="${basePet.name}" class="w-32 h-32 mx-auto mb-3 rounded-full border-4 rarity-${basePet.rarity}">
                        <h2 class="text-2xl font-bold">${basePet.name}</h2>
                        <p class="text-2xl text-yellow-300 mb-2">${renderPetStars(pPet.stars)}</p>
                        <p class="text-sm text-gray-300 mb-4">${basePet.description}</p>
                        <p class="text-sm font-semibold mb-4">B√¥nus Atual: <span class="text-green-300">${currentBonusText}</span></p>

                        <div class="bg-black/30 p-4 rounded-lg">
                             <h3 class="font-bold text-lg mb-2">Evolu√ß√£o</h3>
                             <p class="text-sm mb-2">Pr√≥ximo N√≠vel: <span class="text-yellow-300">${renderPetStars(pPet.stars + 1)}</span></p>
                             <p class="text-sm mb-2">B√¥nus: <span class="text-green-300">${nextBonusText}</span></p>
                             <p class="text-sm mb-4">Custo: ${fragmentsNeeded} Fragmentos (${currentFragments}/${fragmentsNeeded})</p>
                             <button onclick="evolvePet('${instanceId}')" class="w-full font-bold py-2 px-4 rounded ${haveEnoughFragments ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-600 cursor-not-allowed'}" ${!haveEnoughFragments ? 'disabled' : ''}>
                                Evoluir
                             </button>
                        </div>
                    </div>
                    <div class="flex gap-2 mt-4">
                        <button onclick="document.getElementById('pet-detail-modal').classList.add('hidden')" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded">Fechar</button>
                        <button onclick="activatePet('${instanceId}')" class="flex-1 font-bold py-2 px-4 rounded ${isActive ? 'bg-green-600 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}" ${isActive ? 'disabled' : ''}>
                            ${isActive ? '‚úÖ Ativo' : 'Ativar B√¥nus'}
                        </button>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function renderPetsScreen() {
            const container = document.getElementById('pets-screen');
            const pets = playerData.pets || { active: null, collection: {} };
            const activePetInstanceId = pets.active;

            let activePetHTML = `
                <div class="bg-black/30 p-6 rounded-lg text-center">
                    <p class="text-gray-400">Nenhum pet ativo.</p>
                    <p class="text-sm text-gray-500 mt-2">Selecione um pet da sua cole√ß√£o para ativar seus b√¥nus!</p>
                </div>`;
            
            if (activePetInstanceId && pets.collection[activePetInstanceId]) {
                const pPet = pets.collection[activePetInstanceId];
                const basePet = GAME_DB.pets[pPet.id];
                const currentBonus = getPetBonus(pPet);
                let bonusText = Object.entries(currentBonus).map(([stat, value]) => `${stat.replace('_percent','').toUpperCase()} +${(value*100).toFixed(2)}%`).join(', ');

                activePetHTML = `
                <div class="bg-gradient-to-r from-green-900/50 to-emerald-900/50 p-6 rounded-lg border-2 border-green-500">
                    <h3 class="text-xl font-bold mb-4 text-center text-green-300">Pet Ativo</h3>
                    <div class="flex flex-col md:flex-row items-center justify-center gap-6">
                        <img src="${basePet.image}" alt="${basePet.name}" class="w-24 h-24 rounded-full border-4 border-green-400">
                        <div>
                            <h4 class="text-lg font-bold">${basePet.name} <span class="text-yellow-300">${renderPetStars(pPet.stars)}</span></h4>
                            <p class="text-sm text-gray-300 mb-2">${basePet.description}</p>
                            <p class="text-sm font-bold text-yellow-300">B√¥nus Atual: ${bonusText}</p>
                        </div>
                    </div>
                </div>`;
            }

            container.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-center text-green-300">üêâ Sistema de Pets</h2>
                    ${activePetHTML}
                    <h3 class="text-lg font-bold my-4 text-green-300">Cole√ß√£o de Pets</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
                        ${Object.keys(playerData.pets.collection).length > 0 ? 
                            Object.entries(playerData.pets.collection).map(([instanceId, pPet]) => {
                            const basePet = GAME_DB.pets[pPet.id];
                            const isActive = activePetInstanceId === instanceId;
                            return `
                            <div class="bg-black/30 p-4 rounded-lg border-2 ${isActive ? 'border-green-500' : 'border-gray-600'} cursor-pointer hover:border-primary transition-all" onclick="openPetDetailModal('${instanceId}')">
                                <div class="text-center">
                                    <img src="${basePet.image}" alt="${basePet.name}" class="w-16 h-16 mx-auto mb-3 rounded-full">
                                    <h4 class="font-bold mb-2 text-sm truncate">${basePet.name}</h4>
                                    <p class="text-yellow-300">${renderPetStars(pPet.stars)}</p>
                                    ${isActive ? '<p class="text-xs text-green-400 mt-1 font-bold">Ativo</p>' : ''}
                                </div>
                            </div>
                            `;
                        }).join('') : 
                        '<p class="col-span-full text-center text-gray-400">Voc√™ ainda n√£o tem pets. Invoque-os na tela de Recrutar!</p>'}
                    </div>
                    <button onclick="switchScreen('systems')" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg">
                        ‚Üê Voltar aos Sistemas
                    </button>
                </div>
            `;
        }

        function openArtifactDetailModal(instanceId) {
            const modal = document.getElementById('artifact-detail-modal');
            const pArt = playerData.artifacts.collection[instanceId];
            if (!pArt) return;
            const baseArt = GAME_DB.artifacts[pArt.id];
            
            const cost = getEvolveArtifactCost(pArt.level);
            const currentFragments = playerData.artifacts.fragments[pArt.id] || 0;
            const canEvolve = currentFragments >= cost;

            const currentBonus = getArtifactBonus(pArt);
            const nextBonus = getArtifactBonus({ ...pArt, level: pArt.level + 1 });
            let currentBonusText = Object.entries(currentBonus).map(([stat, value]) => `${stat.replace('_percent','').toUpperCase()}% +${value.toFixed(2)}`).join(', ');
            let nextBonusText = Object.entries(nextBonus).map(([stat, value]) => `${stat.replace('_percent','').toUpperCase()}% +${value.toFixed(2)}`).join(', ');
            
            modal.innerHTML = `
                <div class="bg-gray-800 p-4 rounded-lg max-w-lg w-full max-h-[90vh] overflow-y-auto relative border-2 border-yellow-500">
                    <button onclick="document.getElementById('artifact-detail-modal').classList.add('hidden')" class="absolute top-2 right-2 text-white bg-red-600 rounded-full h-8 w-8 font-bold z-10">X</button>
                    <div class="text-center">
                        <img src="${baseArt.image}" alt="${baseArt.name}" class="w-32 h-32 mx-auto mb-3 rounded-full border-4 rarity-${baseArt.rarity}">
                        <h2 class="text-2xl font-bold">${baseArt.name}</h2>
                        <p class="text-lg text-yellow-300 mb-2">N√≠vel ${pArt.level}</p>
                        <p class="text-sm text-gray-300 mb-4">${baseArt.description}</p>
                        <p class="text-sm font-semibold mb-4">B√¥nus Atual: <span class="text-green-300">${currentBonusText}</span></p>

                        <div class="bg-black/30 p-4 rounded-lg">
                             <h3 class="font-bold text-lg mb-2">Evolu√ß√£o</h3>
                             <p class="text-sm mb-2">Pr√≥ximo N√≠vel: <span class="text-yellow-300">${pArt.level + 1}</span></p>
                             <p class="text-sm mb-2">B√¥nus: <span class="text-green-300">${nextBonusText}</span></p>
                             <p class="text-sm mb-4">Custo: ${cost} Fragmentos (${currentFragments}/${cost})</p>
                             <button onclick="evolveArtifact('${instanceId}')" class="w-full font-bold py-2 px-4 rounded ${canEvolve ? 'bg-purple-600 hover:bg-purple-700' : 'bg-gray-600 cursor-not-allowed'}" ${!canEvolve ? 'disabled' : ''}>
                                Evoluir
                             </button>
                        </div>
                    </div>
                </div>
            `;
            modal.classList.remove('hidden');
        }

        function renderArtifactsScreen() {
             const container = document.getElementById('artifacts-screen');
             const artifacts = playerData.artifacts;
             const MAX_EQUIPPED = 3;

             let equippedHTML = `
                <div class="bg-black/30 p-6 rounded-lg">
                    <h3 class="text-xl font-bold mb-4 text-center text-yellow-300">Artefatos Equipados (${artifacts.equipped.length}/${MAX_EQUIPPED})</h3>
                     <div class="flex justify-center items-center gap-4 min-h-[100px]">
                        ${artifacts.equipped.length > 0 ? artifacts.equipped.map(instanceId => {
                            const pArt = artifacts.collection[instanceId];
                            const baseArt = GAME_DB.artifacts[pArt.id];
                            return `<div class="text-center">
                                <img src="${baseArt.image}" alt="${baseArt.name}" class="w-16 h-16 mx-auto rounded-full border-2 rarity-${baseArt.rarity}" onclick="toggleArtifact('${instanceId}')" title="Clique para desequipar">
                                <p class="text-xs mt-1">${baseArt.name}</p>
                            </div>`;
                        }).join('') : '<p class="text-gray-400">Nenhum artefato equipado.</p>'}
                     </div>
                </div>`;
             
             container.innerHTML = `
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-2xl font-bold mb-6 text-center text-yellow-300">‚ú® Sistema de Artefatos</h2>
                    ${equippedHTML}
                    <h3 class="text-lg font-bold my-4 text-yellow-300">Cole√ß√£o de Artefatos</h3>
                    <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mb-6">
                        ${Object.keys(artifacts.collection).length > 0 ? 
                            Object.entries(artifacts.collection).map(([instanceId, pArt]) => {
                            const baseArt = GAME_DB.artifacts[pArt.id];
                            const isEquipped = artifacts.equipped.includes(instanceId);
                            return `
                            <div class="bg-black/30 p-4 rounded-lg border-2 ${isEquipped ? 'border-yellow-500' : 'border-gray-600'} text-center">
                                <img src="${baseArt.image}" alt="${baseArt.name}" class="w-16 h-16 mx-auto mb-3 rounded-full">
                                <h4 class="font-bold mb-1 text-sm truncate">${baseArt.name}</h4>
                                <p class="text-yellow-300 mb-2">N√≠vel ${pArt.level}</p>
                                <div class="flex gap-1 justify-center">
                                    <button class="text-xs bg-blue-600 hover:bg-blue-700 text-white px-2 py-1 rounded" onclick="openArtifactDetailModal('${instanceId}')">Detalhes</button>
                                    <button class="text-xs ${isEquipped ? 'bg-red-600' : 'bg-green-600'} text-white px-2 py-1 rounded" onclick="toggleArtifact('${instanceId}')">${isEquipped ? 'Desequipar' : 'Equipar'}</button>
                                </div>
                            </div>
                            `;
                        }).join('') : 
                        '<p class="col-span-full text-center text-gray-400">Voc√™ ainda n√£o tem artefatos. Invoque-os na tela de Recrutar!</p>'}
                    </div>
                    <button onclick="switchScreen('systems')" class="mt-6 w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-6 rounded-lg">
                        ‚Üê Voltar aos Sistemas
                    </button>
                </div>
            `;
        }

        function renderEventsScreen() { renderPlaceholderScreen('events', 'Eventos', 'üéâ'); }
        function renderSeasonScreen() { renderPlaceholderScreen('season', 'Temporada', 'üèÜ'); }

        // --- DOMContentLoaded (INITIALIZATION) ---
        document.addEventListener('DOMContentLoaded', async () => {
            await handleLogin();
            loadPlayerData();
            initializeAllSystems();
            checkDailyRewards();
            checkAchievements();
            switchScreen('home');
            
            document.getElementById('logout-btn').onclick = handleLogout;
            
            document.querySelectorAll('.nav-button, .mobile-nav-button[data-screen]').forEach(button => {
                button.addEventListener('click', () => {
                    let screenId = button.dataset.screen;
                    switchScreen(screenId);
                });
            });
            
            document.body.addEventListener('click', (e) => {
                const charCard = e.target.closest('[data-char-instance-id]');
                if (charCard) {
                     openCharacterDetailModal(charCard.dataset.charInstanceId);
                }
                const moreMenu = document.getElementById('mobile-more-menu');
                const moreBtn = document.getElementById('mobile-more-btn');
                if (moreMenu && !moreMenu.classList.contains('hidden') && !moreMenu.contains(e.target) && !moreBtn.contains(e.target)) {
                    moreMenu.classList.add('hidden', 'opacity-0', 'translate-y-2');
                }
            });

            const moreMenu = document.getElementById('mobile-more-menu');
            const moreBtn = document.getElementById('mobile-more-btn');
            if(moreBtn) {
                moreBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    moreMenu.classList.toggle('hidden');
                    setTimeout(() => moreMenu.classList.toggle('opacity-0'), 10);
                    setTimeout(() => moreMenu.classList.toggle('translate-y-2'), 10);
                });
            }
            if(moreMenu) {
                moreMenu.querySelectorAll('button[data-screen]').forEach(button => {
                    button.addEventListener('click', () => switchScreen(button.dataset.screen));
                });
            }
            document.getElementById('mobile-logout-btn').onclick = handleLogout;
        });

    </script>
</body>
</html>

